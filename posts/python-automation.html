<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨Pythonè‡ªåŠ¨åŒ–æ‰¹é‡éƒ¨ç½²æœåŠ¡å™¨ - ä½•å“¥çš„åšå®¢</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans SC", sans-serif;
            line-height: 1.7;
            transition: background-color 0.3s, color 0.3s;
        }

        body.light {
            background-color: #f8fafc;
            color: #1f2937;
        }

        body.dark {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        body.light .navbar {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        body.dark .navbar {
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid #1e293b;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            align-items: center;
            list-style: none;
        }

        .nav-menu a {
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            padding: 8px 16px;
            border-radius: 8px;
        }

        body.light .nav-menu a {
            color: #4b5563;
        }

        body.dark .nav-menu a {
            color: #cbd5e1;
        }

        body.light .nav-menu a:hover {
            color: #3b82f6;
            background: #f3f4f6;
        }

        body.dark .nav-menu a:hover {
            color: #60a5fa;
            background: #1e293b;
        }

        .theme-toggle {
            width: 50px;
            height: 26px;
            border-radius: 13px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        body.light .theme-toggle {
            background: #e5e7eb;
        }

        body.dark .theme-toggle {
            background: #3b82f6;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            background: white;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        body.dark .theme-toggle::before {
            transform: translateX(24px);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            max-width: 900px;
            margin: 100px auto 60px;
            padding: 0 20px;
        }

        /* è¿”å›æŒ‰é’® */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        /* æ–‡ç« å¤´éƒ¨ */
        .article-header {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid;
        }

        body.light .article-header {
            border-color: #e5e7eb;
        }

        body.dark .article-header {
            border-color: #334155;
        }

        .article-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 20px;
            line-height: 1.3;
        }

        body.light .article-title {
            color: #1f2937;
        }

        body.dark .article-title {
            color: #f1f5f9;
        }

        .article-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 14px;
        }

        body.light .article-meta {
            color: #6b7280;
        }

        body.dark .article-meta {
            color: #94a3b8;
        }

        .article-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .category-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 13px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
        }

        .article-intro {
            font-size: 16px;
            line-height: 1.8;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 40px;
        }

        body.light .article-intro {
            background: #f8fafc;
            color: #475569;
        }

        body.dark .article-intro {
            background: #1e293b;
            color: #cbd5e1;
        }

        /* ç›®å½• */
        .toc {
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 40px;
            border-left: 4px solid #f97316;
        }

        body.light .toc {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        body.dark .toc {
            background: #1e293b;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .toc h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        body.light .toc h4 {
            color: #1f2937;
        }

        body.dark .toc h4 {
            color: #f1f5f9;
        }

        .toc ul {
            list-style: none;
            display: grid;
            gap: 10px;
        }

        .toc li a {
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s;
            display: block;
        }

        body.light .toc li a {
            color: #4b5563;
        }

        body.dark .toc li a {
            color: #cbd5e1;
        }

        body.light .toc li a:hover {
            color: #f97316;
            background: #f3f4f6;
            transform: translateX(4px);
        }

        body.dark .toc li a:hover {
            color: #fb923c;
            background: #0f172a;
            transform: translateX(4px);
        }

        /* ç›®å½•æ¿€æ´»çŠ¶æ€ */
        .toc li a.active {
            color: #f97316;
            background: rgba(249, 115, 22, 0.1);
            font-weight: 600;
            transform: translateX(8px);
        }

        body.dark .toc li a.active {
            color: #fb923c;
            background: rgba(251, 146, 60, 0.1);
        }

        /* å†…å®¹åŒºå— */
        .content-section {
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        body.light .content-section {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        body.dark .content-section {
            background: #1e293b;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .content-section:hover {
            transform: translateY(-2px);
        }

        body.light .content-section:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark .content-section:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }

        h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid;
        }

        body.light h2 {
            color: #f97316;
            border-color: rgba(249, 115, 22, 0.2);
        }

        body.dark h2 {
            color: #fb923c;
            border-color: rgba(251, 146, 60, 0.2);
        }

        h3 {
            font-size: 20px;
            font-weight: 600;
            margin: 24px 0 16px;
        }

        body.light h3 {
            color: #1f2937;
        }

        body.dark h3 {
            color: #f1f5f9;
        }

        p {
            margin-bottom: 16px;
            font-size: 15px;
            line-height: 1.8;
        }

        ul {
            margin: 16px 0 16px 24px;
            line-height: 1.8;
        }

        li {
            margin-bottom: 10px;
            font-size: 15px;
        }

        strong {
            font-weight: 600;
        }

        body.light strong {
            color: #1f2937;
        }

        body.dark strong {
            color: #f1f5f9;
        }

        /* ä»£ç å— */
        .code-container {
            position: relative;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
        }

        pre {
            padding: 24px;
            overflow-x: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            border-left: 4px solid #f97316;
        }

        body.light pre {
            background: #f1f5f9;
        }

        body.dark pre {
            background: #0f172a;
        }

        code {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        body.light code {
            color: #dc2626;
            background: #f1f5f9;
        }

        body.dark code {
            color: #f87171;
            background: #1e293b;
        }

        /* ä»£ç è¯­æ³•é«˜äº® */
        .keyword { color: #f97316; font-weight: bold; }
        .string { color: #10b981; }
        .constant { color: #8b5cf6; }
        .comment { color: #6b7280; font-style: italic; }

        body.dark .keyword { color: #fb923c; }
        body.dark .string { color: #34d399; }
        body.dark .constant { color: #a78bfa; }
        body.dark .comment { color: #94a3b8; }

        .copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 8px 16px;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #ea580c;
        }

        .copy-btn.copied {
            background: #3b82f6;
        }

        /* è­¦å‘Šæç¤º */
        .warning-tip {
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        body.light .warning-tip {
            background: rgba(245, 158, 11, 0.1);
        }

        body.dark .warning-tip {
            background: rgba(245, 158, 11, 0.15);
        }

        .warning-tip strong {
            color: #f59e0b;
            display: block;
            margin-bottom: 8px;
        }

        /* å±é™©æç¤º */
        .danger-tip {
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }

        body.light .danger-tip {
            background: rgba(239, 68, 68, 0.1);
        }

        body.dark .danger-tip {
            background: rgba(239, 68, 68, 0.15);
        }

        .danger-tip strong {
            color: #ef4444;
            display: block;
            margin-bottom: 8px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .deploy-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
        }

        .deploy-table th, .deploy-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid;
        }

        body.light .deploy-table th {
            background: #f1f5f9;
            color: #1f2937;
            border-color: #e5e7eb;
        }

        body.dark .deploy-table th {
            background: #0f172a;
            color: #f1f5f9;
            border-color: #334155;
        }

        body.light .deploy-table td {
            border-color: #e5e7eb;
        }

        body.dark .deploy-table td {
            border-color: #334155;
        }

        /* éƒ¨ç½²åœºæ™¯å¡ç‰‡ */
        .deploy-scene {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .scene-card {
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        body.light .scene-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
        }

        body.dark .scene-card {
            background: #0f172a;
            border: 1px solid #334155;
        }

        .scene-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        body.dark .scene-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .scene-card h4 {
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #f97316;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .article-title {
                font-size: 28px;
            }

            .content-section {
                padding: 20px;
            }

            pre {
                padding: 16px;
                font-size: 13px;
            }

            .copy-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .deploy-table th, .deploy-table td {
                padding: 8px 10px;
                font-size: 14px;
            }

            .deploy-scene {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 0 16px;
            }

            .toc {
                padding: 16px;
            }

            .article-title {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            h3 {
                font-size: 18px;
            }

            .deploy-table {
                font-size: 13px;
            }
        }

        /* å›åˆ°é¡¶éƒ¨æŒ‰é’® */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #f97316;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
            transition: all 0.3s;
            opacity: 0;
            visibility: hidden;
            z-index: 999;
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            background: #ea580c;
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="dark">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">ä½•å“¥çš„åšå®¢</a>
            <ul class="nav-menu">
                <li><a href="../index.html">é¦–é¡µ</a></li>
                <li><a href="../index.html#projects">é¡¹ç›®æ¡ˆä¾‹</a></li>
                <li><a href="../index.html#experience">å·¥ä½œç»å†</a></li>
                <li><a href="../pages/articles.html">æŠ€æœ¯æ–‡ç« </a></li>
                <li><a href="../pages/about.html">å…³äºæˆ‘</a></li>
            </ul>
            <div class="theme-toggle" onclick="toggleTheme()"></div>
        </div>
    </nav>

    <main class="main-content">
        <!-- è¿”å›æŒ‰é’® -->
        <a href="../pages/articles.html" class="back-button">
            <i class="fas fa-arrow-left"></i>
            <span>è¿”å›æ–‡ç« åˆ—è¡¨</span>
        </a>

        <!-- æ–‡ç« å¤´éƒ¨ -->
        <div class="article-header">
            <h1 class="article-title">ç”¨Pythonè‡ªåŠ¨åŒ–æ‰¹é‡éƒ¨ç½²æœåŠ¡å™¨</h1>
            <div class="article-meta">
                <span class="category-badge">Pythonè‡ªåŠ¨åŒ–</span>
                <span><i class="far fa-calendar"></i> 2025-12-15</span>
                <span><i class="far fa-clock"></i> é˜…è¯» 6 åˆ†é’Ÿ</span>
                <span><i class="far fa-eye"></i> 892 æ¬¡æµè§ˆ</span>
            </div>
        </div>

        <!-- æ–‡ç« ç®€ä»‹ -->
        <div class="article-intro">
            è¿ç»´100+å°æœåŠ¡å™¨æ—¶ï¼Œæ‰‹åŠ¨é…ç½®ç¯å¢ƒã€å®‰è£…è½¯ä»¶ã€éƒ¨ç½²æœåŠ¡çš„é‡å¤åŠ³åŠ¨è€—æ—¶åˆæ˜“å‡ºé”™ï¼æœ¬æ–‡åŸºäºå®æˆ˜ç»éªŒï¼Œåˆ†äº«ä¸€å¥—å¯ç›´æ¥å¤ç”¨çš„Pythonè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼Œå®ç°ä»æœåŠ¡å™¨åˆå§‹åŒ–ã€ç¯å¢ƒé…ç½®ã€è½¯ä»¶å®‰è£…åˆ°æœåŠ¡éƒ¨ç½²çš„å…¨æµç¨‹è‡ªåŠ¨åŒ–ã€‚åŒ…å«Paramikoæ‰¹é‡æ‰§è¡Œå‘½ä»¤ã€Fabric3æ‰¹é‡éƒ¨ç½²ã€é…ç½®æ–‡ä»¶ç®¡ç†ã€é”™è¯¯é‡è¯•ã€æ—¥å¿—è®°å½•ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œå¸®ä½ èŠ‚çœ90%çš„é‡å¤åŠ³åŠ¨ï¼Œ1å°æ—¶å®ŒæˆåŸæœ¬10å°æ—¶çš„éƒ¨ç½²å·¥ä½œã€‚
        </div>

        <!-- ç›®å½• -->
        <div class="toc">
            <h4>ğŸ“‹ æ–‡ç« ç›®å½•</h4>
            <ul>
                <li><a href="#prepare">ä¸€ã€æ‰¹é‡éƒ¨ç½²å‰çš„å‡†å¤‡å·¥ä½œ</a></li>
                <li><a href="#paramiko">äºŒã€åŸºäºParamikoçš„åŸºç¡€æ‰¹é‡æ“ä½œ</a></li>
                <li><a href="#fabric">ä¸‰ã€Fabric3è¿›é˜¶æ‰¹é‡éƒ¨ç½²</a></li>
                <li><a href="#config">å››ã€é…ç½®æ–‡ä»¶ç®¡ç†ä¸åŠ¨æ€å‚æ•°</a></li>
                <li><a href="#error">äº”ã€é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶</a></li>
                <li><a href="#log">å…­ã€éƒ¨ç½²æ—¥å¿—ä¸è¿›åº¦ç›‘æ§</a></li>
                <li><a href="#case">ä¸ƒã€å®æˆ˜æ¡ˆä¾‹ï¼š100+æœåŠ¡å™¨æ‰¹é‡éƒ¨ç½²Nginx</a></li>
                <li><a href="#optimize">å…«ã€æ€§èƒ½ä¼˜åŒ–ä¸å¤§è§„æ¨¡éƒ¨ç½²æŠ€å·§</a></li>
                <li><a href="#summary">ä¹ã€æ€»ç»“ä¸æ‰©å±•åœºæ™¯</a></li>
            </ul>
        </div>

        <!-- æ‰¹é‡éƒ¨ç½²å‰çš„å‡†å¤‡å·¥ä½œ -->
        <section class="content-section" id="prepare">
            <h2>ä¸€ã€æ‰¹é‡éƒ¨ç½²å‰çš„å‡†å¤‡å·¥ä½œ</h2>
            
            <h3>1. ç¯å¢ƒä¾èµ–å®‰è£…</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code># å®‰è£…æ ¸å¿ƒä¾èµ–åº“
pip install paramiko fabric3 pyyaml python-dotenv tqdm

# ä¾èµ–è¯´æ˜ï¼š
# paramikoï¼šSSHè¿æ¥æ ¸å¿ƒåº“ï¼Œå®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œ
# fabric3ï¼šåŸºäºparamikoçš„å°è£…ï¼Œç®€åŒ–æ‰¹é‡æ“ä½œ
# pyyamlï¼šé…ç½®æ–‡ä»¶è§£æï¼ˆæœåŠ¡å™¨åˆ—è¡¨ã€éƒ¨ç½²å‚æ•°ï¼‰
# python-dotenvï¼šç¯å¢ƒå˜é‡ç®¡ç†ï¼ˆæ•æ„Ÿä¿¡æ¯å¦‚SSHå¯†ç ï¼‰
# tqdmï¼šè¿›åº¦æ¡æ˜¾ç¤ºï¼Œç›‘æ§éƒ¨ç½²è¿›åº¦</code></pre>
            </div>

            <h3>2. æœåŠ¡å™¨ä¿¡æ¯æ•´ç†</h3>
            <p>å°†æ‰€æœ‰æœåŠ¡å™¨ä¿¡æ¯æ•´ç†åˆ°YAMLé…ç½®æ–‡ä»¶ï¼Œç»Ÿä¸€ç®¡ç†ï¼Œé¿å…ç¡¬ç¼–ç ï¼š</p>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code># servers.yaml æœåŠ¡å™¨é…ç½®æ–‡ä»¶
servers:
  # ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨ç»„
  production:
    - host: 192.168.1.101
      port: 22
      username: root
      password: ${PROD_SSH_PWD}  # ä»ç¯å¢ƒå˜é‡è¯»å–å¯†ç 
      tags: ["web", "nginx"]
    - host: 192.168.1.102
      port: 22
      username: root
      password: ${PROD_SSH_PWD}
      tags: ["web", "nginx"]
    # æ›´å¤šç”Ÿäº§æœåŠ¡å™¨...
  
  # æµ‹è¯•ç¯å¢ƒæœåŠ¡å™¨ç»„
  test:
    - host: 192.168.2.101
      port: 22
      username: root
      password: ${TEST_SSH_PWD}
      tags: ["test", "nginx"]
    # æ›´å¤šæµ‹è¯•æœåŠ¡å™¨...

# .env ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆgitå¿½ç•¥ï¼Œé¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼‰
PROD_SSH_PWD=ä½ çš„ç”Ÿäº§æœåŠ¡å™¨å¯†ç 
TEST_SSH_PWD=ä½ çš„æµ‹è¯•æœåŠ¡å™¨å¯†ç </code></pre>
            </div>

            <h3>3. SSHå…å¯†ç™»å½•é…ç½®ï¼ˆæ¨èï¼‰</h3>
            <div class="warning-tip">
                <strong>âš ï¸ å®‰å…¨æç¤º:</strong>
                <p>ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨SSHå¯†é’¥ç™»å½•ï¼Œè€Œéå¯†ç ç™»å½•ï¼ä»¥ä¸‹æ˜¯æ‰¹é‡é…ç½®å…å¯†ç™»å½•çš„è„šæœ¬ï¼š</p>
            </div>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code>#!/usr/bin/env python3
# ssh_key_deploy.py æ‰¹é‡é…ç½®SSHå…å¯†ç™»å½•
import os
import paramiko
import yaml
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶
load_dotenv()
with open("servers.yaml", "r", encoding="utf-8") as f:
    config = yaml.safe_load(f)

# æœ¬åœ°å…¬é’¥è·¯å¾„
PUBLIC_KEY_PATH = os.path.expanduser("~/.ssh/id_rsa.pub")

def deploy_ssh_key(host, port, username, password):
    """å‘å•å°æœåŠ¡å™¨éƒ¨ç½²SSHå…¬é’¥"""
    try:
        # è¯»å–æœ¬åœ°å…¬é’¥
        with open(PUBLIC_KEY_PATH, "r") as f:
            pub_key = f.read().strip()
        
        # å»ºç«‹SSHè¿æ¥
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(host, port=port, username=username, password=password, timeout=10)
        
        # æ‰§è¡Œå‘½ä»¤ï¼šåˆ›å»º.sshç›®å½•ï¼Œæ·»åŠ å…¬é’¥åˆ°authorized_keys
        commands = [
            "mkdir -p ~/.ssh && chmod 700 ~/.ssh",
            f'echo "{pub_key}" >> ~/.ssh/authorized_keys',
            "chmod 600 ~/.ssh/authorized_keys"
        ]
        
        for cmd in commands:
            stdin, stdout, stderr = ssh.exec_command(cmd)
            stdout.channel.recv_exit_status()  # ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæˆ
            if stderr.read():
                print(f"[{host}] æ‰§è¡Œå‘½ä»¤å¤±è´¥: {cmd}")
                return False
        
        ssh.close()
        print(f"[{host}] SSHå…å¯†ç™»å½•é…ç½®æˆåŠŸ")
        return True
    except Exception as e:
        print(f"[{host}] é…ç½®å¤±è´¥: {str(e)}")
        return False

if __name__ == "__main__":
    # éå†æ‰€æœ‰ç”Ÿäº§æœåŠ¡å™¨é…ç½®å…å¯†ç™»å½•
    for server in config["servers"]["production"]:
        # æ›¿æ¢ç¯å¢ƒå˜é‡
        password = os.environ.get(server["password"].replace("${", "").replace("}", ""))
        deploy_ssh_key(
            host=server["host"],
            port=server["port"],
            username=server["username"],
            password=password
        )</code></pre>
            </div>
        </section>

        <!-- åŸºäºParamikoçš„åŸºç¡€æ‰¹é‡æ“ä½œ -->
        <section class="content-section" id="paramiko">
            <h2>äºŒã€åŸºäºParamikoçš„åŸºç¡€æ‰¹é‡æ“ä½œ</h2>
            
            <h3>1. æ‰¹é‡æ‰§è¡Œå‘½ä»¤ï¼ˆæ ¸å¿ƒè„šæœ¬ï¼‰</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code>#!/usr/bin/env python3
# batch_execute.py æ‰¹é‡æ‰§è¡Œå‘½ä»¤
import os
import paramiko
import yaml
import threading
from dotenv import load_dotenv
from tqdm import tqdm  # è¿›åº¦æ¡

# åŠ è½½é…ç½®
load_dotenv()
with open("servers.yaml", "r", encoding="utf-8") as f:
    config = yaml.safe_load(f)

# å…¨å±€å˜é‡ï¼šè¿›åº¦æ¡ã€é”
progress_bar = None
lock = threading.Lock()

def execute_command(server, commands, result_dict):
    """æ‰§è¡Œå•å°æœåŠ¡å™¨çš„å‘½ä»¤"""
    host = server["host"]
    try:
        # æ›¿æ¢å¯†ç ç¯å¢ƒå˜é‡
        password = os.environ.get(server["password"].replace("${", "").replace("}", ""))
        
        # å»ºç«‹SSHè¿æ¥
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(
            hostname=server["host"],
            port=server["port"],
            username=server["username"],
            password=password,
            timeout=15,
            allow_agent=False,
            look_for_keys=False
        )
        
        # æ‰§è¡Œå‘½ä»¤
        output = {}
        for cmd in commands:
            stdin, stdout, stderr = ssh.exec_command(cmd, get_pty=True)
            # è¯»å–è¾“å‡ºï¼ˆé¿å…ç¼“å†²åŒºæº¢å‡ºï¼‰
            stdout_content = stdout.read().decode("utf-8", errors="ignore")
            stderr_content = stderr.read().decode("utf-8", errors="ignore")
            output[cmd] = {
                "stdout": stdout_content,
                "stderr": stderr_content,
                "exit_code": stdout.channel.recv_exit_status()
            }
        
        ssh.close()
        
        # æ›´æ–°ç»“æœå’Œè¿›åº¦
        with lock:
            result_dict[host] = {"status": "success", "output": output}
            progress_bar.update(1)
    except Exception as e:
        with lock:
            result_dict[host] = {"status": "failed", "error": str(e)}
            progress_bar.update(1)

def batch_execute(server_group, commands, max_threads=10):
    """æ‰¹é‡æ‰§è¡Œå‘½ä»¤ï¼ˆå¤šçº¿ç¨‹ï¼‰"""
    global progress_bar
    servers = config["servers"][server_group]
    result_dict = {}
    
    # åˆå§‹åŒ–è¿›åº¦æ¡
    progress_bar = tqdm(total=len(servers), desc=f"æ‰¹é‡æ‰§è¡Œå‘½ä»¤ ({server_group})")
    
    # å¤šçº¿ç¨‹æ‰§è¡Œ
    threads = []
    semaphore = threading.Semaphore(max_threads)  # é™åˆ¶å¹¶å‘æ•°
    
    def worker(server):
        with semaphore:
            execute_command(server, commands, result_dict)
    
    for server in servers:
        t = threading.Thread(target=worker, args=(server,))
        threads.append(t)
        t.start()
    
    # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for t in threads:
        t.join()
    
    progress_bar.close()
    return result_dict

if __name__ == "__main__":
    # ç¤ºä¾‹ï¼šæ‰¹é‡åœ¨ç”Ÿäº§æœåŠ¡å™¨æ‰§è¡Œç³»ç»Ÿæ›´æ–°å’ŒæŸ¥çœ‹ç£ç›˜ç©ºé—´
    commands = [
        "yum update -y",
        "df -h",
        "free -m"
    ]
    
    # æ‰§è¡Œæ‰¹é‡å‘½ä»¤
    results = batch_execute("production", commands, max_threads=10)
    
    # è¾“å‡ºæ‰§è¡Œç»“æœ
    print("\n===== æ‰§è¡Œç»“æœæ±‡æ€» =====")
    success_count = 0
    failed_count = 0
    for host, result in results.items():
        if result["status"] == "success":
            success_count += 1
            print(f"âœ… {host}: æ‰§è¡ŒæˆåŠŸ")
        else:
            failed_count += 1
            print(f"âŒ {host}: æ‰§è¡Œå¤±è´¥ - {result['error']}")
    
    print(f"\næ€»è®¡: {success_count} å°æˆåŠŸ, {failed_count} å°å¤±è´¥")</code></pre>
            </div>

            <h3>2. æ‰¹é‡ä¸Šä¼ æ–‡ä»¶</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code>def upload_file(server, local_path, remote_path):
    """ä¸Šä¼ æ–‡ä»¶åˆ°å•å°æœåŠ¡å™¨"""
    host = server["host"]
    try:
        # æ›¿æ¢å¯†ç ç¯å¢ƒå˜é‡
        password = os.environ.get(server["password"].replace("${", "").replace("}", ""))
        
        # å»ºç«‹SFTPè¿æ¥
        transport = paramiko.Transport((host, server["port"]))
        transport.connect(username=server["username"], password=password)
        sftp = paramiko.SFTPClient.from_transport(transport)
        
        # ä¸Šä¼ æ–‡ä»¶ï¼ˆæ”¯æŒç›®å½•é€’å½’ä¸Šä¼ ï¼‰
        if os.path.isdir(local_path):
            # é€’å½’åˆ›å»ºè¿œç¨‹ç›®å½•
            sftp.mkdir(remote_path, mode=0o755)
            for root, dirs, files in os.walk(local_path):
                # è®¡ç®—ç›¸å¯¹è·¯å¾„
                rel_path = os.path.relpath(root, local_path)
                remote_dir = os.path.join(remote_path, rel_path)
                
                # åˆ›å»ºè¿œç¨‹å­ç›®å½•
                if rel_path != ".":
                    try:
                        sftp.mkdir(remote_dir, mode=0o755)
                    except IOError:
                        pass  # ç›®å½•å·²å­˜åœ¨
                
                # ä¸Šä¼ æ–‡ä»¶
                for file in files:
                    local_file = os.path.join(root, file)
                    remote_file = os.path.join(remote_dir, file)
                    sftp.put(local_file, remote_file)
        else:
            # ä¸Šä¼ å•ä¸ªæ–‡ä»¶
            sftp.put(local_path, remote_path)
        
        sftp.close()
        transport.close()
        
        with lock:
            progress_bar.update(1)
        return True
    except Exception as e:
        print(f"[{host}] æ–‡ä»¶ä¸Šä¼ å¤±è´¥: {str(e)}")
        with lock:
            progress_bar.update(1)
        return False

# æ‰¹é‡ä¸Šä¼ æ–‡ä»¶è°ƒç”¨ç¤ºä¾‹
def batch_upload(server_group, local_path, remote_path, max_threads=10):
    servers = config["servers"][server_group]
    global progress_bar
    progress_bar = tqdm(total=len(servers), desc=f"æ‰¹é‡ä¸Šä¼ æ–‡ä»¶ ({server_group})")
    
    threads = []
    semaphore = threading.Semaphore(max_threads)
    
    def worker(server):
        with semaphore:
            upload_file(server, local_path, remote_path)
    
    for server in servers:
        t = threading.Thread(target=worker, args=(server,))
        threads.append(t)
        t.start()
    
    for t in threads:
        t.join()
    
    progress_bar.close()

# è°ƒç”¨ç¤ºä¾‹ï¼šæ‰¹é‡ä¸Šä¼ Nginxé…ç½®æ–‡ä»¶åˆ°æ‰€æœ‰ç”Ÿäº§æœåŠ¡å™¨
if __name__ == "__main__":
    batch_upload(
        server_group="production",
        local_path="./nginx_config",
        remote_path="/etc/nginx/conf.d",
        max_threads=10
    )</code></pre>
            </div>
        </section>

        <!-- Fabric3è¿›é˜¶æ‰¹é‡éƒ¨ç½² -->
        <section class="content-section" id="fabric">
            <h2>ä¸‰ã€Fabric3è¿›é˜¶æ‰¹é‡éƒ¨ç½²</h2>
            
            <h3>1. Fabric3æ ¸å¿ƒä¼˜åŠ¿</h3>
            <div class="deploy-scene">
                <div class="scene-card">
                    <h4><i class="fas fa-code"></i> è¯­æ³•æ›´ç®€æ´</h4>
                    <p>åŸºäºè£…é¥°å™¨çš„è¯­æ³•ï¼Œä¸€è¡Œä»£ç å®ç°æ‰¹é‡æ“ä½œï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†SSHè¿æ¥</p>
                </div>
                <div class="scene-card">
                    <h4><i class="fas fa-tasks"></i> å†…ç½®æ‰¹é‡åŠŸèƒ½</h4>
                    <p>åŸç”Ÿæ”¯æŒå¤šæœåŠ¡å™¨æ‰¹é‡æ‰§è¡Œï¼Œå†…ç½®å¹¶è¡Œæ‰§è¡Œã€å¤±è´¥é‡è¯•ç­‰æœºåˆ¶</p>
                </div>
                <div class="scene-card">
                    <h4><i class="fas fa-file-upload"></i> æ–‡ä»¶æ“ä½œä¾¿æ·</h4>
                    <p>ç®€åŒ–çš„æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½APIï¼Œæ”¯æŒæœ¬åœ°-è¿œç¨‹æ–‡ä»¶åŒæ­¥</p>
                </div>
            </div>

            <h3>2. Fabric3æ‰¹é‡éƒ¨ç½²è„šæœ¬</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code># fabfile.py Fabric3éƒ¨ç½²è„šæœ¬
from fabric import Connection, task
from fabric.exceptions import GroupException
from invoke.exceptions import UnexpectedExit
import yaml
import os
from dotenv import load_dotenv

# åŠ è½½é…ç½®
load_dotenv()
with open("servers.yaml", "r", encoding="utf-8") as f:
    config = yaml.safe_load(f)

# æ„å»ºæœåŠ¡å™¨è¿æ¥åˆ—è¡¨
def get_connections(server_group):
    """è·å–æœåŠ¡å™¨è¿æ¥åˆ—è¡¨"""
    connections = []
    for server in config["servers"][server_group]:
        # æ›¿æ¢å¯†ç ç¯å¢ƒå˜é‡
        password = os.environ.get(server["password"].replace("${", "").replace("}", ""))
        # åˆ›å»ºè¿æ¥
        conn = Connection(
            host=server["host"],
            port=server["port"],
            user=server["username"],
            connect_kwargs={"password": password}
        )
        connections.append(conn)
    return connections

# æ‰¹é‡å®‰è£…Nginx
@task
def install_nginx(ctx, env="production"):
    """æ‰¹é‡å®‰è£…Nginx"""
    connections = get_connections(env)
    print(f"å¼€å§‹åœ¨{env}ç¯å¢ƒçš„{len(connections)}å°æœåŠ¡å™¨å®‰è£…Nginx...")
    
    # å¹¶è¡Œæ‰§è¡Œå®‰è£…å‘½ä»¤
    try:
        for conn in connections:
            # å®‰è£…ä¾èµ–
            conn.run("yum install -y gcc pcre-devel zlib-devel openssl-devel", hide=True)
            # ä¸‹è½½å¹¶ç¼–è¯‘å®‰è£…Nginx
            conn.run("wget http://nginx.org/download/nginx-1.24.0.tar.gz -P /tmp", hide=True)
            conn.run("cd /tmp && tar -zxvf nginx-1.24.0.tar.gz", hide=True)
            conn.run(
                "cd /tmp/nginx-1.24.0 && ./configure --prefix=/usr/local/nginx --with-http_ssl_module && make && make install",
                hide=True
            )
            # åˆ›å»ºç³»ç»ŸæœåŠ¡
            conn.run("""
                cat > /usr/lib/systemd/system/nginx.service << EOF
[Unit]
Description=nginx - high performance web server
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=/usr/local/nginx/logs/nginx.pid
ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
ExecReload=/usr/local/nginx/sbin/nginx -s reload
ExecStop=/usr/local/nginx/sbin/nginx -s stop
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF
            """, hide=True)
            # å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
            conn.run("systemctl daemon-reload && systemctl start nginx && systemctl enable nginx", hide=True)
            print(f"âœ… {conn.host}: Nginxå®‰è£…æˆåŠŸ")
    except GroupException as e:
        for conn, exc in e.result.items():
            print(f"âŒ {conn.host}: Nginxå®‰è£…å¤±è´¥ - {exc}")
    except UnexpectedExit as e:
        print(f"å‘½ä»¤æ‰§è¡Œå¤±è´¥: {e}")

# æ‰¹é‡éƒ¨ç½²Nginxé…ç½®
@task
def deploy_nginx_config(ctx, env="production"):
    """æ‰¹é‡éƒ¨ç½²Nginxé…ç½®æ–‡ä»¶"""
    connections = get_connections(env)
    print(f"å¼€å§‹å‘{env}ç¯å¢ƒéƒ¨ç½²Nginxé…ç½®...")
    
    for conn in connections:
        # ä¸Šä¼ é…ç½®æ–‡ä»¶
        conn.put("./nginx.conf", "/usr/local/nginx/conf/nginx.conf", preserve_mode=True)
        # éªŒè¯é…ç½®å¹¶é‡å¯
        result = conn.run("/usr/local/nginx/sbin/nginx -t", warn=True)
        if result.ok:
            conn.run("systemctl restart nginx")
            print(f"âœ… {conn.host}: Nginxé…ç½®éƒ¨ç½²æˆåŠŸ")
        else:
            print(f"âŒ {conn.host}: Nginxé…ç½®éªŒè¯å¤±è´¥ - {result.stderr}")

# æ‰¹é‡æ£€æŸ¥æœåŠ¡çŠ¶æ€
@task
def check_nginx_status(ctx, env="production"):
    """æ‰¹é‡æ£€æŸ¥NginxçŠ¶æ€"""
    connections = get_connections(env)
    print(f"æ£€æŸ¥{env}ç¯å¢ƒNginxçŠ¶æ€...")
    
    for conn in connections:
        result = conn.run("systemctl is-active nginx", warn=True)
        if result.stdout.strip() == "active":
            print(f"âœ… {conn.host}: Nginxè¿è¡Œæ­£å¸¸")
        else:
            print(f"âŒ {conn.host}: Nginxæœªè¿è¡Œ - {result.stdout}")

# å‘½ä»¤è¡Œè°ƒç”¨ç¤ºä¾‹ï¼š
# fab install_nginx --env=production    # ç”Ÿäº§ç¯å¢ƒæ‰¹é‡å®‰è£…Nginx
# fab deploy_nginx_config --env=test    # æµ‹è¯•ç¯å¢ƒéƒ¨ç½²é…ç½®
# fab check_nginx_status --env=production  # æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒNginxçŠ¶æ€</code></pre>
            </div>
        </section>

        <!-- é…ç½®æ–‡ä»¶ç®¡ç†ä¸åŠ¨æ€å‚æ•° -->
        <section class="content-section" id="config">
            <h2>å››ã€é…ç½®æ–‡ä»¶ç®¡ç†ä¸åŠ¨æ€å‚æ•°</h2>
            
            <h3>1. æ¨¡æ¿åŒ–é…ç½®æ–‡ä»¶ï¼ˆJinja2ï¼‰</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code># 1. å®‰è£…Jinja2
# pip install jinja2

# 2. Nginxé…ç½®æ¨¡æ¿ (nginx_template.conf)
'''
worker_processes {{ worker_processes }};  # åŠ¨æ€å‚æ•°ï¼šCPUæ ¸å¿ƒæ•°
error_log /var/log/nginx/error.log {{ log_level }};

events {
    worker_connections {{ worker_connections }};
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    sendfile        on;
    keepalive_timeout  65;
    
    {% for server in servers %}
    server {
        listen       {{ server.port }};
        server_name  {{ server.domain }};
        
        location / {
            proxy_pass http://{{ server.upstream }};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        access_log /var/log/nginx/{{ server.domain }}.log;
    }
    {% endfor %}
}
'''

# 3. åŠ¨æ€æ¸²æŸ“é…ç½®æ–‡ä»¶è„šæœ¬
import jinja2
import yaml

def render_config_template(template_path, config_path, output_path):
"""æ¸²æŸ“é…ç½®æ¨¡æ¿"""
# åŠ è½½æ¨¡æ¿
env = jinja2.Environment(loader=jinja2.FileSystemLoader("."))
template = env.get_template(template_path)

# åŠ è½½é…ç½®ï¼ˆä»YAMLæ–‡ä»¶è¯»å–åŠ¨æ€å‚æ•°ï¼‰
with open(config_path, "r", encoding="utf-8") as f:
    config_data = yaml.safe_load(f)

# å¯é€‰ï¼šåŠ¨æ€è·å–æœåŠ¡å™¨CPUæ ¸å¿ƒæ•°ï¼ˆç”¨äºworker_processeså‚æ•°ï¼‰
def get_cpu_cores():
    """è·å–æœ¬åœ°CPUæ ¸å¿ƒæ•°ï¼ˆè‹¥éƒ¨ç½²åˆ°è¿œç¨‹å¯é€šè¿‡SSHæ‰§è¡Œnprocå‘½ä»¤ï¼‰"""
    import multiprocessing
    return multiprocessing.cpu_count()

# è¡¥å……åŠ¨æ€å‚æ•°
config_data["worker_processes"] = config_data.get("worker_processes", get_cpu_cores())
config_data["log_level"] = config_data.get("log_level", "warn")
config_data["worker_connections"] = config_data.get("worker_connections", 1024)

# æ¸²æŸ“æ¨¡æ¿å¹¶è¾“å‡ºæ–‡ä»¶
with open(output_path, "w", encoding="utf-8") as f:
    rendered_content = template.render(**config_data)
    f.write(rendered_content)

print(f"âœ… é…ç½®æ¨¡æ¿æ¸²æŸ“å®Œæˆï¼Œè¾“å‡ºæ–‡ä»¶ï¼š{output_path}")

# ========== é…ç½®æ–‡ä»¶ç¤ºä¾‹ (nginx_config.yaml) ==========
'''
# nginx_config.yaml åŠ¨æ€é…ç½®å‚æ•°
worker_processes: 4  # è‹¥ä¸æŒ‡å®šåˆ™è‡ªåŠ¨è·å–CPUæ ¸å¿ƒæ•°
log_level: info
worker_connections: 2048
servers:
  - port: 80
    domain: www.example.com
    upstream: 127.0.0.1:8080
  - port: 443
    domain: www.example.com
    upstream: 127.0.0.1:8080
    ssl: true
    ssl_cert: /etc/nginx/certs/example.crt
    ssl_key: /etc/nginx/certs/example.key
'''

# ========== è°ƒç”¨ç¤ºä¾‹ ==========
if __name__ == "__main__":
    # æ¸²æŸ“Nginxé…ç½®æ¨¡æ¿
    render_config_template(
        template_path="nginx_template.conf",  # æ¨¡æ¿æ–‡ä»¶è·¯å¾„
        config_path="nginx_config.yaml",      # é…ç½®å‚æ•°æ–‡ä»¶
        output_path="nginx.conf"              # æ¸²æŸ“åçš„è¾“å‡ºæ–‡ä»¶
    )
    
    # æ¸²æŸ“å®Œæˆåï¼Œå¯ç›´æ¥è°ƒç”¨ä¹‹å‰çš„æ‰¹é‡ä¸Šä¼ å‡½æ•°éƒ¨ç½²åˆ°æœåŠ¡å™¨
    # batch_upload("production", "./nginx.conf", "/usr/local/nginx/conf/nginx.conf")</code></pre>
            </div>

            <h3>2. å¤šç¯å¢ƒé…ç½®éš”ç¦»</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code># configs/ é…ç½®ç›®å½•ç»“æ„
# configs/
# â”œâ”€â”€ base.yaml          # åŸºç¡€é€šç”¨é…ç½®
# â”œâ”€â”€ production.yaml    # ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆç»§æ‰¿baseï¼‰
# â”œâ”€â”€ test.yaml          # æµ‹è¯•ç¯å¢ƒé…ç½®ï¼ˆç»§æ‰¿baseï¼‰
# â””â”€â”€ development.yaml   # å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆç»§æ‰¿baseï¼‰

# 1. åŸºç¡€é…ç½® (base.yaml)
'''
# é€šç”¨é…ç½®
nginx:
  worker_processes: auto
  worker_connections: 1024
  log_level: warn
  timeout: 60s
common:
  timezone: Asia/Shanghai
  charset: utf-8
  backup_dir: /data/backup
'''

# 2. ç”Ÿäº§ç¯å¢ƒé…ç½® (production.yaml)
'''
# ç»§æ‰¿åŸºç¡€é…ç½®
extends: base.yaml

# è¦†ç›–/æ–°å¢ç”Ÿäº§ç¯å¢ƒé…ç½®
nginx:
  worker_processes: 8
  worker_connections: 2048
  log_level: info
  access_log: /var/log/nginx/access.log
common:
  backup_cron: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
  monitor_enabled: true
'''

# 3. é…ç½®åŠ è½½å·¥å…·ç±»
import yaml
import os

class ConfigLoader:
    """å¤šç¯å¢ƒé…ç½®åŠ è½½å™¨"""
    def __init__(self, config_dir="configs"):
        self.config_dir = config_dir
        self.config_cache = {}
    
    def load_config(self, env):
        """åŠ è½½æŒ‡å®šç¯å¢ƒçš„é…ç½®ï¼ˆæ”¯æŒç»§æ‰¿ï¼‰"""
        if env in self.config_cache:
            return self.config_cache[env]
        
        # åŠ è½½å½“å‰ç¯å¢ƒé…ç½®
        env_config_path = os.path.join(self.config_dir, f"{env}.yaml")
        if not os.path.exists(env_config_path):
            raise FileNotFoundError(f"é…ç½®æ–‡ä»¶ {env_config_path} ä¸å­˜åœ¨")
        
        with open(env_config_path, "r", encoding="utf-8") as f:
            env_config = yaml.safe_load(f)
        
        # å¤„ç†ç»§æ‰¿
        if "extends" in env_config:
            parent_env = env_config.pop("extends")
            parent_config = self.load_config(parent_env.replace(".yaml", ""))
            # åˆå¹¶é…ç½®ï¼ˆå­é…ç½®è¦†ç›–çˆ¶é…ç½®ï¼‰
            config = self._merge_config(parent_config, env_config)
        else:
            config = env_config
        
        self.config_cache[env] = config
        return config
    
    def _merge_config(self, parent, child):
        """é€’å½’åˆå¹¶é…ç½®å­—å…¸"""
        merged = parent.copy()
        for key, value in child.items():
            if key in merged and isinstance(merged[key], dict) and isinstance(value, dict):
                merged[key] = self._merge_config(merged[key], value)
            else:
                merged[key] = value
        return merged

# é…ç½®åŠ è½½ç¤ºä¾‹
if __name__ == "__main__":
    config_loader = ConfigLoader()
    
    # åŠ è½½ç”Ÿäº§ç¯å¢ƒé…ç½®
    prod_config = config_loader.load_config("production")
    print("ç”Ÿäº§ç¯å¢ƒNginxé…ç½®ï¼š", prod_config["nginx"])
    
    # åŠ è½½æµ‹è¯•ç¯å¢ƒé…ç½®
    test_config = config_loader.load_config("test")
    print("æµ‹è¯•ç¯å¢ƒé€šç”¨é…ç½®ï¼š", test_config["common"])
    
    # æ¸²æŸ“é…ç½®æ—¶ä¼ å…¥å¯¹åº”ç¯å¢ƒçš„é…ç½®
    # render_config_template(
    #     template_path="nginx_template.conf",
    #     config_path=f"configs/{env}.yaml",
    #     output_path=f"nginx_{env}.conf"
    # )</code></pre>
            </div>

            <h3>3. å‘½ä»¤è¡Œå‚æ•°åŠ¨æ€ä¼ å‚</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code>#!/usr/bin/env python3
# deploy_with_args.py æ”¯æŒå‘½ä»¤è¡Œå‚æ•°çš„éƒ¨ç½²è„šæœ¬
import argparse
import sys
from batch_execute import batch_execute
from config_loader import ConfigLoader

def parse_args():
    """è§£æå‘½ä»¤è¡Œå‚æ•°"""
    parser = argparse.ArgumentParser(description="Pythonæ‰¹é‡æœåŠ¡å™¨éƒ¨ç½²å·¥å…·")
    
    # å¿…é€‰å‚æ•°
    parser.add_argument(
        "--env", 
        required=True,
        choices=["development", "test", "production"],
        help="éƒ¨ç½²ç¯å¢ƒï¼šdevelopment/test/production"
    )
    
    # å¯é€‰å‚æ•°
    parser.add_argument(
        "--action",
        default="deploy",
        choices=["deploy", "install", "config", "check", "backup"],
        help="æ‰§è¡Œæ“ä½œï¼šdeploy(éƒ¨ç½²)/install(å®‰è£…)/config(é…ç½®)/check(æ£€æŸ¥)/backup(å¤‡ä»½)"
    )
    
    parser.add_argument(
        "--servers",
        nargs="+",
        help="æŒ‡å®šæœåŠ¡å™¨IPåˆ—è¡¨ï¼ˆä¸æŒ‡å®šåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰æœåŠ¡å™¨ï¼‰"
    )
    
    parser.add_argument(
        "--threads",
        type=int,
        default=10,
        help="å¹¶å‘çº¿ç¨‹æ•°ï¼ˆé»˜è®¤10ï¼‰"
    )
    
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="æ¨¡æ‹Ÿæ‰§è¡Œï¼ˆä¸å®é™…æ“ä½œæœåŠ¡å™¨ï¼‰"
    )
    
    return parser.parse_args()

def main():
    """ä¸»å‡½æ•°"""
    args = parse_args()
    print(f"å¼€å§‹æ‰§è¡Œéƒ¨ç½²ä»»åŠ¡ | ç¯å¢ƒï¼š{args.env} | æ“ä½œï¼š{args.action} | å¹¶å‘æ•°ï¼š{args.threads}")
    
    # åŠ è½½å¯¹åº”ç¯å¢ƒé…ç½®
    config_loader = ConfigLoader()
    env_config = config_loader.load_config(args.env)
    
    # æ¨¡æ‹Ÿæ‰§è¡Œæ¨¡å¼æç¤º
    if args.dry_run:
        print("âš ï¸  æ¨¡æ‹Ÿæ‰§è¡Œæ¨¡å¼ï¼Œä¸ä¼šå®é™…æ“ä½œæœåŠ¡å™¨ï¼")
    
    # æ ¹æ®æ“ä½œç±»å‹æ‰§è¡Œä¸åŒé€»è¾‘
    if args.action == "install":
        # å®‰è£…å‘½ä»¤ï¼ˆä»é…ç½®è¯»å–ï¼‰
        install_commands = env_config.get("install_commands", [
            "yum install -y nginx",
            "systemctl enable nginx"
        ])
        
        if not args.dry_run:
            results = batch_execute(
                server_group=args.env,
                commands=install_commands,
                max_threads=args.threads
            )
            # å¤„ç†æ‰§è¡Œç»“æœ
            success = sum(1 for r in results.values() if r["status"] == "success")
            print(f"å®‰è£…å®Œæˆ | æˆåŠŸï¼š{success}/{len(results)} å°æœåŠ¡å™¨")
    
    elif args.action == "deploy":
        print(f"å¼€å§‹éƒ¨ç½² {args.env} ç¯å¢ƒé…ç½®...")
        # éƒ¨ç½²é€»è¾‘ï¼ˆçœç•¥å…·ä½“å®ç°ï¼‰
    
    elif args.action == "check":
        print(f"æ£€æŸ¥ {args.env} ç¯å¢ƒæœåŠ¡çŠ¶æ€...")
        # æ£€æŸ¥é€»è¾‘ï¼ˆçœç•¥å…·ä½“å®ç°ï¼‰
    
    elif args.action == "backup":
        print(f"æ‰§è¡Œ {args.env} ç¯å¢ƒå¤‡ä»½ä»»åŠ¡...")
        # å¤‡ä»½é€»è¾‘ï¼ˆçœç•¥å…·ä½“å®ç°")

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print(f"âŒ æ‰§è¡Œå¤±è´¥ï¼š{str(e)}")
        sys.exit(1)

# å‘½ä»¤è¡Œè°ƒç”¨ç¤ºä¾‹ï¼š
# python deploy_with_args.py --env production --action install --threads 15
# python deploy_with_args.py --env test --action deploy --dry-run
# python deploy_with_args.py --env production --action check --servers 192.168.1.101 192.168.1.102</code></pre>
            </div>
        </section>

        <!-- é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶ -->
        <section class="content-section" id="error">
            <h2>äº”ã€é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶</h2>
            
            <h3>1. æ™ºèƒ½é‡è¯•è£…é¥°å™¨</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code>import time
import functools
from functools import wraps

def retry(max_retries=3, delay=2, backoff=2, exceptions=(Exception,)):
    """
    é‡è¯•è£…é¥°å™¨
    :param max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
    :param delay: åˆå§‹å»¶è¿Ÿï¼ˆç§’ï¼‰
    :param backoff: å»¶è¿Ÿå€æ•°ï¼ˆæ¯æ¬¡é‡è¯•å»¶è¿Ÿ * backoffï¼‰
    :param exceptions: éœ€è¦é‡è¯•çš„å¼‚å¸¸ç±»å‹
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            _max_retries = max_retries
            _delay = delay
            
            while _max_retries > 0:
                try:
                    return func(*args, **kwargs)
                except exceptions as e:
                    _max_retries -= 1
                    if _max_retries == 0:
                        raise  # æœ€åä¸€æ¬¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
                    
                    # æ‰“å°é‡è¯•ä¿¡æ¯
                    host = args[0] if args else "æœªçŸ¥æœåŠ¡å™¨"
                    print(f"âš ï¸  [{host}] {func.__name__} æ‰§è¡Œå¤±è´¥: {str(e)} | å‰©ä½™é‡è¯•æ¬¡æ•°: {_max_retries} | å»¶è¿Ÿ {_delay} ç§’")
                    
                    # å»¶è¿Ÿåé‡è¯•
                    time.sleep(_delay)
                    _delay *= backoff  # æŒ‡æ•°é€€é¿
            return None
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹ï¼šä¸ºSSHè¿æ¥å’Œå‘½ä»¤æ‰§è¡Œæ·»åŠ é‡è¯•æœºåˆ¶
@retry(max_retries=3, delay=2, backoff=2, exceptions=(paramiko.SSHException, TimeoutError))
def execute_command_with_retry(server, command):
    """å¸¦é‡è¯•æœºåˆ¶çš„å‘½ä»¤æ‰§è¡Œå‡½æ•°"""
    host = server["host"]
    password = os.environ.get(server["password"].replace("${", "").replace("}", ""))
    
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(
        hostname=host,
        port=server["port"],
        username=server["username"],
        password=password,
        timeout=10
    )
    
    stdin, stdout, stderr = ssh.exec_command(command)
    exit_code = stdout.channel.recv_exit_status()
    
    if exit_code != 0:
        error_msg = stderr.read().decode("utf-8", errors="ignore")
        raise RuntimeError(f"å‘½ä»¤æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : {exit_code}): {error_msg}")
    
    result = stdout.read().decode("utf-8", errors="ignore")
    ssh.close()
    return result

# è°ƒç”¨ç¤ºä¾‹
if __name__ == "__main__":
    server = {"host": "192.168.1.101", "port": 22, "username": "root", "password": "${PROD_SSH_PWD}"}
    try:
        # æ‰§è¡Œå¯èƒ½å¤±è´¥çš„å‘½ä»¤ï¼ˆå¦‚ç½‘ç»œæ³¢åŠ¨å¯¼è‡´è¿æ¥å¤±è´¥ï¼‰
        result = execute_command_with_retry(server, "systemctl restart nginx")
        print(f"âœ…  {server['host']} å‘½ä»¤æ‰§è¡ŒæˆåŠŸ: {result}")
    except Exception as e:
        print(f"âŒ  {server['host']} å‘½ä»¤æ‰§è¡Œæœ€ç»ˆå¤±è´¥: {str(e)}")</code></pre>
            </div>

            <h3>2. å¼‚å¸¸åˆ†ç±»å¤„ç†ä¸å‘Šè­¦</h3>
            <div class="danger-tip">
                <strong>ğŸš¨ é‡è¦æé†’:</strong>
                <p>ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéƒ¨ç½²å¤±è´¥éœ€è¦åŠæ—¶å‘Šè­¦ï¼ˆé‚®ä»¶/é’‰é’‰/ä¼ä¸šå¾®ä¿¡ï¼‰ï¼Œé¿å…é—®é¢˜æ‰©å¤§ï¼</p>
            </div>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code>import smtplib
from email.mime.text import MIMEText
from email.header import Header

# å¼‚å¸¸ç±»å‹å®šä¹‰
class DeployError(Exception):
    """éƒ¨ç½²åŸºç±»å¼‚å¸¸"""
    pass

class SSHConnectError(DeployError):
    """SSHè¿æ¥å¼‚å¸¸"""
    pass

class CommandExecuteError(DeployError):
    """å‘½ä»¤æ‰§è¡Œå¼‚å¸¸"""
    pass

class FileUploadError(DeployError):
    """æ–‡ä»¶ä¸Šä¼ å¼‚å¸¸"""
    pass

# å‘Šè­¦å·¥å…·ç±»
class AlertManager:
    """å‘Šè­¦ç®¡ç†å™¨"""
    def __init__(self, smtp_config):
        self.smtp_host = smtp_config["host"]
        self.smtp_port = smtp_config["port"]
        self.smtp_user = smtp_config["user"]
        self.smtp_password = smtp_config["password"]
        self.recipients = smtp_config["recipients"]
    
    def send_email_alert(self, subject, content):
        """å‘é€é‚®ä»¶å‘Šè­¦"""
        try:
            msg = MIMEText(content, "plain", "utf-8")
            msg["From"] = Header("æœåŠ¡å™¨éƒ¨ç½²ç³»ç»Ÿ", "utf-8")
            msg["To"] = Header(",".join(self.recipients), "utf-8")
            msg["Subject"] = Header(subject, "utf-8")
            
            # å‘é€é‚®ä»¶
            server = smtplib.SMTP_SSL(self.smtp_host, self.smtp_port)
            server.login(self.smtp_user, self.smtp_password)
            server.sendmail(self.smtp_user, self.recipients, msg.as_string())
            server.quit()
            
            print("ğŸ“§ å‘Šè­¦é‚®ä»¶å‘é€æˆåŠŸ")
        except Exception as e:
            print(f"âŒ å‘Šè­¦é‚®ä»¶å‘é€å¤±è´¥: {str(e)}")
    
    def send_dingding_alert(self, webhook, content):
        """å‘é€é’‰é’‰å‘Šè­¦ï¼ˆå¯é€‰ï¼‰"""
        import requests
        try:
            data = {
                "msgtype": "text",
                "text": {
                    "content": content
                }
            }
            response = requests.post(webhook, json=data, timeout=10)
            if response.json()["errcode"] != 0:
                raise Exception(f"é’‰é’‰å‘Šè­¦å¤±è´¥: {response.text}")
            print("ğŸ“± é’‰é’‰å‘Šè­¦å‘é€æˆåŠŸ")
        except Exception as e:
            print(f"âŒ é’‰é’‰å‘Šè­¦å‘é€å¤±è´¥: {str(e)}")

# å¼‚å¸¸å¤„ç†ä¸»é€»è¾‘
def handle_deploy_exception(server, exc, alert_manager=None):
    """å¤„ç†éƒ¨ç½²å¼‚å¸¸å¹¶å‘é€å‘Šè­¦"""
    host = server["host"]
    error_type = type(exc).__name__
    
    # æ„å»ºå‘Šè­¦å†…å®¹
    subject = f"ã€æœåŠ¡å™¨éƒ¨ç½²å¤±è´¥ã€‘{host} - {error_type}"
    content = f"""
æœåŠ¡å™¨éƒ¨ç½²å¤±è´¥è¯¦æƒ…ï¼š
æœåŠ¡å™¨IP: {host}
å¼‚å¸¸ç±»å‹: {error_type}
å¼‚å¸¸ä¿¡æ¯: {str(exc)}
éƒ¨ç½²æ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}
æœåŠ¡å™¨æ ‡ç­¾: {server.get('tags', 'æ— ')}
    """.strip()
    
    # æ‰“å°é”™è¯¯æ—¥å¿—
    print(f"\n{content}\n")
    
    # å‘é€å‘Šè­¦
    if alert_manager:
        alert_manager.send_email_alert(subject, content)
        # å¯é€‰ï¼šå‘é€é’‰é’‰å‘Šè­¦
        # alert_manager.send_dingding_alert("https://oapi.dingtalk.com/robot/send?access_token=xxx", content)

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åˆå§‹åŒ–å‘Šè­¦ç®¡ç†å™¨
    smtp_config = {
        "host": "smtp.163.com",
        "port": 465,
        "user": "your_email@163.com",
        "password": "your_email_password",
        "recipients": ["admin@example.com", "ops@example.com"]
    }
    alert_manager = AlertManager(smtp_config)
    
    # æ¨¡æ‹Ÿéƒ¨ç½²å¤±è´¥
    server = {"host": "192.168.1.101", "port": 22, "username": "root", "tags": ["web", "nginx"]}
    try:
        # æ¨¡æ‹ŸSSHè¿æ¥å¤±è´¥
        raise SSHConnectError("è¿æ¥è¶…æ—¶ï¼ˆæœåŠ¡å™¨å¯èƒ½å®•æœºï¼‰")
    except DeployError as e:
        handle_deploy_exception(server, e, alert_manager)</code></pre>
            </div>
        </section>

        <!-- éƒ¨ç½²æ—¥å¿—ä¸è¿›åº¦ç›‘æ§ -->
        <section class="content-section" id="log">
            <h2>å…­ã€éƒ¨ç½²æ—¥å¿—ä¸è¿›åº¦ç›‘æ§</h2>
            
            <h3>1. ç»“æ„åŒ–æ—¥å¿—è®°å½•</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code>import logging
import json
import os
from datetime import datetime

# é…ç½®æ—¥å¿—
def setup_deploy_logger(log_dir="deploy_logs"):
    """é…ç½®éƒ¨ç½²æ—¥å¿—è®°å½•å™¨"""
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    os.makedirs(log_dir, exist_ok=True)
    
    # æ—¥å¿—æ–‡ä»¶åï¼ˆæŒ‰æ—¥æœŸï¼‰
    log_file = os.path.join(log_dir, f"deploy_{datetime.now().strftime('%Y%m%d')}.log")
    
    # é…ç½®æ—¥å¿—æ ¼å¼
    log_format = "%(asctime)s - %(levelname)s - %(module)s - %(message)s"
    logging.basicConfig(
        level=logging.INFO,
        format=log_format,
        handlers=[
            logging.FileHandler(log_file, encoding="utf-8"),  # æ–‡ä»¶æ—¥å¿—
            logging.StreamHandler()  # æ§åˆ¶å°æ—¥å¿—
        ]
    )
    
    return logging.getLogger("deploy")

# åˆå§‹åŒ–æ—¥å¿—å™¨
logger = setup_deploy_logger()

# ç»“æ„åŒ–æ—¥å¿—è®°å½•å‡½æ•°
def log_deploy_operation(server, operation, status, details=None):
    """è®°å½•éƒ¨ç½²æ“ä½œæ—¥å¿—ï¼ˆç»“æ„åŒ–ï¼‰"""
    log_data = {
        "timestamp": datetime.now().isoformat(),
        "server": server["host"],
        "port": server["port"],
        "username": server["username"],
        "tags": server.get("tags", []),
        "operation": operation,
        "status": status,  # success/failed/running
        "details": details or {}
    }
    
    # è®°å½•JSONæ ¼å¼æ—¥å¿—ï¼ˆä¾¿äºåç»­åˆ†æï¼‰
    log_message = json.dumps(log_data, ensure_ascii=False)
    
    if status == "success":
        logger.info(log_message)
    elif status == "failed":
        logger.error(log_message)
    elif status == "running":
        logger.warning(log_message)

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    server = {"host": "192.168.1.101", "port": 22, "username": "root", "tags": ["web", "nginx"]}
    
    # è®°å½•å¼€å§‹éƒ¨ç½²
    log_deploy_operation(
        server=server,
        operation="install_nginx",
        status="running",
        details={"version": "1.24.0"}
    )
    
    try:
        # æ¨¡æ‹Ÿéƒ¨ç½²æˆåŠŸ
        log_deploy_operation(
            server=server,
            operation="install_nginx",
            status="success",
            details={"version": "1.24.0", "duration": "45ç§’"}
        )
    except Exception as e:
        # è®°å½•éƒ¨ç½²å¤±è´¥
        log_deploy_operation(
            server=server,
            operation="install_nginx",
            status="failed",
            details={"error": str(e), "retry_count": 3}
        )</code></pre>
            </div>

            <h3>2. å®æ—¶è¿›åº¦ç›‘æ§ï¼ˆWebå¯è§†åŒ–ï¼‰</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code># 1. å®‰è£…ä¾èµ–
# pip install flask flask-socketio eventlet

# 2. è¿›åº¦ç›‘æ§æœåŠ¡ (deploy_monitor.py)
from flask import Flask, render_template
from flask_socketio import SocketIO, emit
import eventlet
import threading
import json
from batch_execute import batch_execute

eventlet.monkey_patch()

app = Flask(__name__)
app.config['SECRET_KEY'] = 'deploy_monitor_secret'
socketio = SocketIO(app, cors_allowed_origins="*")

# å…¨å±€è¿›åº¦å­˜å‚¨
deploy_progress = {
    "total": 0,
    "completed": 0,
    "success": 0,
    "failed": 0,
    "servers": {}
}

def update_progress(host, status, details=None):
    """æ›´æ–°è¿›åº¦å¹¶æ¨é€è‡³å‰ç«¯"""
    global deploy_progress
    
    if status == "success":
        deploy_progress["success"] += 1
    elif status == "failed":
        deploy_progress["failed"] += 1
    
    deploy_progress["completed"] += 1
    deploy_progress["servers"][host] = {
        "status": status,
        "details": details or {},
        "timestamp": datetime.now().isoformat()
    }
    
    # æ¨é€è¿›åº¦åˆ°å‰ç«¯
    socketio.emit('progress_update', {
        "progress": deploy_progress,
        "percentage": (deploy_progress["completed"] / deploy_progress["total"]) * 100 if deploy_progress["total"] > 0 else 0
    }, broadcast=True)

@app.route('/')
def index():
    """ç›‘æ§é¡µé¢"""
    return render_template('monitor.html')

@socketio.on('start_deploy')
def handle_start_deploy(data):
    """å¤„ç†å¼€å§‹éƒ¨ç½²è¯·æ±‚"""
    global deploy_progress
    
    # é‡ç½®è¿›åº¦
    deploy_progress = {
        "total": 0,
        "completed": 0,
        "success": 0,
        "failed": 0,
        "servers": {}
    }
    
    # è·å–éƒ¨ç½²å‚æ•°
    server_group = data.get("server_group", "production")
    commands = data.get("commands", [])
    max_threads = data.get("max_threads", 10)
    
    # è¯»å–æœåŠ¡å™¨åˆ—è¡¨
    with open("servers.yaml", "r", encoding="utf-8") as f:
        config = yaml.safe_load(f)
    servers = config["servers"][server_group]
    deploy_progress["total"] = len(servers)
    
    # å¯åŠ¨éƒ¨ç½²çº¿ç¨‹ï¼ˆé¿å…é˜»å¡Flaskï¼‰
    def deploy_thread():
        results = batch_execute(server_group, commands, max_threads)
        
        # æ›´æ–°è¿›åº¦
        for host, result in results.items():
            update_progress(
                host=host,
                status=result["status"],
                details=result.get("error") or result.get("output")
            )
        
        # å‘é€éƒ¨ç½²å®Œæˆé€šçŸ¥
        socketio.emit('deploy_complete', {
            "success": deploy_progress["success"],
            "failed": deploy_progress["failed"],
            "total": deploy_progress["total"]
        }, broadcast=True)
    
    threading.Thread(target=deploy_thread).start()

if __name__ == "__main__":
    socketio.run(app, host='0.0.0.0', port=5000, debug=True)

# 3. ç›‘æ§é¡µé¢æ¨¡æ¿ (templates/monitor.html)
'''
<!DOCTYPE html>
<html>
<head>
    <title>æœåŠ¡å™¨éƒ¨ç½²ç›‘æ§</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .progress-container { width: 100%; height: 30px; border: 1px solid #ccc; border-radius: 15px; overflow: hidden; margin: 20px 0; }
        .progress-bar { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s; }
        .server-status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .failed { background: #ffebee; color: #c62828; }
        .stats { font-size: 18px; margin: 10px 0; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();
            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');
            const statsDiv = document.getElementById('stats');
            const serversDiv = document.getElementById('servers');
            
            // å¼€å§‹éƒ¨ç½²
            document.getElementById('start-btn').addEventListener('click', function() {
                socket.emit('start_deploy', {
                    server_group: 'production',
                    commands: ['yum install -y nginx', 'systemctl start nginx'],
                    max_threads: 10
                });
                serversDiv.innerHTML = '';
                statsDiv.innerHTML = '';
            });
            
            // æ¥æ”¶è¿›åº¦æ›´æ–°
            socket.on('progress_update', function(data) {
                progressBar.style.width = data.percentage + '%';
                progressPercent.textContent = data.percentage.toFixed(1) + '%';
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                statsDiv.innerHTML = `
                    æ€»æœåŠ¡å™¨: ${data.progress.total} | 
                    å·²å®Œæˆ: ${data.progress.completed} | 
                    æˆåŠŸ: ${data.progress.success} | 
                    å¤±è´¥: ${data.progress.failed}
                `;
                
                // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€
                for (const [host, info] of Object.entries(data.progress.servers)) {
                    let serverEl = document.getElementById(`server-${host}`);
                    if (!serverEl) {
                        serverEl = document.createElement('div');
                        serverEl.id = `server-${host}`;
                        serverEl.className = `server-status ${info.status}`;
                        serversDiv.appendChild(serverEl);
                    }
                    serverEl.innerHTML = `<strong>${host}</strong>: ${info.status} - ${JSON.stringify(info.details)}`;
                }
            });
            
            // éƒ¨ç½²å®Œæˆ
            socket.on('deploy_complete', function(data) {
                alert(`éƒ¨ç½²å®Œæˆï¼æˆåŠŸ: ${data.success}, å¤±è´¥: ${data.failed}`);
            });
        });
    </script>
</head>
<body>
    <h1>æœåŠ¡å™¨æ‰¹é‡éƒ¨ç½²ç›‘æ§</h1>
    <button id="start-btn">å¼€å§‹éƒ¨ç½²</button>
    <div class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
    </div>
    <div id="progress-percent">0%</div>
    <div id="stats" class="stats"></div>
    <div id="servers"></div>
</body>
</html>
'''</code></pre>
            </div>
        </section>

        <!-- å®æˆ˜æ¡ˆä¾‹ï¼š100+æœåŠ¡å™¨æ‰¹é‡éƒ¨ç½²Nginx -->
        <section class="content-section" id="case">
            <h2>ä¸ƒã€å®æˆ˜æ¡ˆä¾‹ï¼š100+æœåŠ¡å™¨æ‰¹é‡éƒ¨ç½²Nginx</h2>
            
            <h3>1. å®Œæ•´éƒ¨ç½²è„šæœ¬</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code>#!/usr/bin/env python3
# full_nginx_deploy.py å®Œæ•´çš„Nginxæ‰¹é‡éƒ¨ç½²è„šæœ¬
import os
import yaml
import logging
from dotenv import load_dotenv
from tqdm import tqdm
from threading import Thread, Lock, Semaphore
from config_loader import ConfigLoader
from alert_manager import AlertManager
from retry import retry
import paramiko

# åˆå§‹åŒ–é…ç½®
load_dotenv()
logger = setup_deploy_logger()
config_loader = ConfigLoader()
alert_manager = AlertManager({
    "host": os.getenv("SMTP_HOST"),
    "port": int(os.getenv("SMTP_PORT", 465)),
    "user": os.getenv("SMTP_USER"),
    "password": os.getenv("SMTP_PASSWORD"),
    "recipients": os.getenv("ALERT_RECIPIENTS").split(",")
})

# å…¨å±€å˜é‡
lock = Lock()
progress_bar = None
deploy_results = {}

class NginxDeployer:
    """Nginxæ‰¹é‡éƒ¨ç½²å™¨"""
    def __init__(self, env="production", max_threads=20):
        self.env = env
        self.max_threads = max_threads
        self.config = config_loader.load_config(env)
        self.servers = self._load_servers()
        self.semaphore = Semaphore(max_threads)
    
    def _load_servers(self):
        """åŠ è½½æœåŠ¡å™¨åˆ—è¡¨"""
        with open("servers.yaml", "r", encoding="utf-8") as f:
            servers_config = yaml.safe_load(f)
        return servers_config["servers"][self.env]
    
    @retry(max_retries=3, delay=2, backoff=2, exceptions=(paramiko.SSHException, TimeoutError))
    def _connect_ssh(self, server):
        """å»ºç«‹SSHè¿æ¥ï¼ˆå¸¦é‡è¯•ï¼‰"""
        password = os.environ.get(server["password"].replace("${", "").replace("}", ""))
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(
            hostname=server["host"],
            port=server["port"],
            username=server["username"],
            password=password,
            timeout=15,
            allow_agent=False,
            look_for_keys=False
        )
        return ssh
    
    def _execute_command(self, ssh, command, desc="æ‰§è¡Œå‘½ä»¤"):
        """æ‰§è¡Œå•ä¸ªå‘½ä»¤"""
        stdin, stdout, stderr = ssh.exec_command(command, get_pty=True)
        exit_code = stdout.channel.recv_exit_status()
        stdout_content = stdout.read().decode("utf-8", errors="ignore")
        stderr_content = stderr.read().decode("utf-8", errors="ignore")
        
        if exit_code != 0:
            raise RuntimeError(f"{desc}å¤±è´¥ (é€€å‡ºç : {exit_code}): {stderr_content}")
        
        return stdout_content
    
    def _deploy_single_server(self, server):
        """éƒ¨ç½²å•å°æœåŠ¡å™¨"""
        host = server["host"]
        try:
            with self.semaphore:
                # è®°å½•å¼€å§‹éƒ¨ç½²
                log_deploy_operation(server, "nginx_deploy", "running")
                logger.info(f"å¼€å§‹éƒ¨ç½² {host} Nginx")
                
                # å»ºç«‹SSHè¿æ¥
                ssh = self._connect_ssh(server)
                
                # 1. å®‰è£…ä¾èµ–
                logger.info(f"{host} å®‰è£…ä¾èµ–åŒ…")
                self._execute_command(
                    ssh,
                    "yum install -y gcc pcre-devel zlib-devel openssl-devel wget",
                    "å®‰è£…ä¾èµ–åŒ…"
                )
                
                # 2. ä¸‹è½½å¹¶ç¼–è¯‘å®‰è£…Nginx
                nginx_version = self.config["nginx"]["version"]
                logger.info(f"{host} å®‰è£…Nginx {nginx_version}")
                self._execute_command(
                    ssh,
                    f"wget http://nginx.org/download/nginx-{nginx_version}.tar.gz -P /tmp -q",
                    "ä¸‹è½½Nginxæºç "
                )
                self._execute_command(
                    ssh,
                    f"cd /tmp && tar -zxf nginx-{nginx_version}.tar.gz",
                    "è§£å‹Nginxæºç "
                )
                self._execute_command(
                    ssh,
                    f"cd /tmp/nginx-{nginx_version} && ./configure {self.config['nginx']['configure_args']} && make -j$(nproc) && make install",
                    "ç¼–è¯‘å®‰è£…Nginx"
                )
                
                # 3. é…ç½®ç³»ç»ŸæœåŠ¡
                logger.info(f"{host} é…ç½®Nginxç³»ç»ŸæœåŠ¡")
                self._execute_command(
                    ssh,
                    f"echo '{self.config['nginx']['service_file']}' > /usr/lib/systemd/system/nginx.service",
                    "åˆ›å»ºç³»ç»ŸæœåŠ¡æ–‡ä»¶"
                )
                
                # 4. æ¸²æŸ“å¹¶ä¸Šä¼ é…ç½®æ–‡ä»¶
                logger.info(f"{host} éƒ¨ç½²Nginxé…ç½®")
                # æœ¬åœ°æ¸²æŸ“é…ç½®æ–‡ä»¶
                render_config_template(
                    template_path="nginx_template.conf",
                    config_path=f"configs/{self.env}.yaml",
                    output_path=f"temp/nginx_{host}.conf"
                )
                # ä¸Šä¼ é…ç½®æ–‡ä»¶
                sftp = ssh.open_sftp()
                sftp.put(f"temp/nginx_{host}.conf", "/usr/local/nginx/conf/nginx.conf")
                sftp.close()
                
                # 5. å¯åŠ¨å¹¶éªŒè¯
                logger.info(f"{host} å¯åŠ¨NginxæœåŠ¡")
                self._execute_command(ssh, "systemctl daemon-reload", "é‡è½½ç³»ç»ŸæœåŠ¡")
                self._execute_command(ssh, "systemctl enable nginx --now", "å¯åŠ¨NginxæœåŠ¡")
                self._execute_command(ssh, "/usr/local/nginx/sbin/nginx -t", "éªŒè¯Nginxé…ç½®")
                
                # 6. æ£€æŸ¥æœåŠ¡çŠ¶æ€
                status = self._execute_command(ssh, "systemctl is-active nginx", "æ£€æŸ¥NginxçŠ¶æ€")
                if status.strip() != "active":
                    raise RuntimeError(f"NginxæœåŠ¡æœªæ­£å¸¸å¯åŠ¨: {status}")
                
                # å…³é—­è¿æ¥
                ssh.close()
                
                # è®°å½•éƒ¨ç½²æˆåŠŸ
                log_deploy_operation(
                    server,
                    "nginx_deploy",
                    "success",
                    {"version": nginx_version, "status": "active"}
                )
                logger.info(f"{host} Nginxéƒ¨ç½²æˆåŠŸ")
                
                with lock:
                    deploy_results[host] = {"status": "success"}
                    progress_bar.update(1)
                
        except Exception as e:
            # è®°å½•éƒ¨ç½²å¤±è´¥
            log_deploy_operation(
                server,
                "nginx_deploy",
                "failed",
                {"error": str(e)}
            )
            logger.error(f"{host} Nginxéƒ¨ç½²å¤±è´¥: {str(e)}")
            
            # å‘é€å‘Šè­¦
            handle_deploy_exception(server, e, alert_manager)
            
            with lock:
                deploy_results[host] = {"status": "failed", "error": str(e)}
                progress_bar.update(1)
    
    def deploy(self):
        """æ‰¹é‡éƒ¨ç½²Nginx"""
        global progress_bar
        deploy_results.clear()
        
        # åˆå§‹åŒ–è¿›åº¦æ¡
        progress_bar = tqdm(total=len(self.servers), desc=f"éƒ¨ç½²Nginxåˆ°{self.env}ç¯å¢ƒ")
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        os.makedirs("temp", exist_ok=True)
        
        # å¯åŠ¨éƒ¨ç½²çº¿ç¨‹
        threads = []
        for server in self.servers:
            t = Thread(target=self._deploy_single_server, args=(server,))
            threads.append(t)
            t.start()
        
        # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        for t in threads:
            t.join()
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        os.system("rm -rf temp/*")
        
        # è¾“å‡ºéƒ¨ç½²ç»“æœ
        progress_bar.close()
        success_count = sum(1 for r in deploy_results.values() if r["status"] == "success")
        failed_count = len(deploy_results) - success_count
        
        logger.info(f"éƒ¨ç½²å®Œæˆ | æ€»è®¡: {len(deploy_results)} å° | æˆåŠŸ: {success_count} | å¤±è´¥: {failed_count}")
        print(f"\n===== éƒ¨ç½²ç»“æœæ±‡æ€» ({self.env}ç¯å¢ƒ) =====")
        print(f"æ€»æœåŠ¡å™¨æ•°: {len(self.servers)} å°")
        print(f"âœ… æˆåŠŸéƒ¨ç½²: {success_count} å°")
        print(f"âŒ éƒ¨ç½²å¤±è´¥: {failed_count} å°")

        # è¾“å‡ºæˆåŠŸåˆ—è¡¨
        if success_count > 0:
            print("\nã€æˆåŠŸæœåŠ¡å™¨åˆ—è¡¨ã€‘:")
            for host in [k for k, v in deploy_results.items() if v["status"] == "success"]:
                print(f"  - {host}")

        # è¾“å‡ºå¤±è´¥è¯¦æƒ…
        if failed_count > 0:
            print("\nã€å¤±è´¥æœåŠ¡å™¨è¯¦æƒ…ã€‘:")
            for host, result in deploy_results.items():
                if result["status"] == "failed":
                    print(f"\n  ğŸš¨ {host}:")
                    print(f"     é”™è¯¯åŸå› : {result['error']}")
                    # å¦‚æœæœ‰å‘½ä»¤æ‰§è¡Œè¾“å‡ºï¼Œè¡¥å……è¾“å‡º
                    if "output" in result:
                        for cmd, cmd_result in result["output"].items():
                            if cmd_result.get("stderr"):
                                print(f"     å‘½ä»¤: {cmd}")
                                print(f"     é”™è¯¯è¾“å‡º: {cmd_result['stderr'][:200]}...")  # æˆªæ–­è¿‡é•¿è¾“å‡º

        # ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Šæ–‡ä»¶
        report_path = f"./deploy_reports/nginx_deploy_{self.env}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
        os.makedirs("./deploy_reports", exist_ok=True)

        with open(report_path, "w", encoding="utf-8") as f:
            f.write(f"===== Nginxæ‰¹é‡éƒ¨ç½²æŠ¥å‘Š ({self.env}ç¯å¢ƒ) =====\n")
            f.write(f"éƒ¨ç½²æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"æ€»æœåŠ¡å™¨æ•°: {len(self.servers)}\n")
            f.write(f"æˆåŠŸæ•°: {success_count}\n")
            f.write(f"å¤±è´¥æ•°: {failed_count}\n\n")
            
            f.write("ã€æˆåŠŸæœåŠ¡å™¨ã€‘:\n")
            for host in [k for k, v in deploy_results.items() if v["status"] == "success"]:
                f.write(f"  - {host}\n")
            
            f.write("\nã€å¤±è´¥æœåŠ¡å™¨ã€‘:\n")
            for host, result in deploy_results.items():
                if result["status"] == "failed":
                    f.write(f"\n  {host}:\n")
                    f.write(f"    é”™è¯¯: {result['error']}\n")

        logger.info(f"éƒ¨ç½²æŠ¥å‘Šå·²ç”Ÿæˆ: {report_path}")
        print(f"\nğŸ“„ éƒ¨ç½²æŠ¥å‘Šå·²ä¿å­˜è‡³: {report_path}")

        # å¤±è´¥æ•°è¶…è¿‡é˜ˆå€¼æ—¶å‘é€å‘Šè­¦ï¼ˆç¤ºä¾‹ï¼šé‚®ä»¶/é’‰é’‰/ä¼ä¸šå¾®ä¿¡ï¼‰
        if failed_count > 0 and failed_count / len(self.servers) > 0.1:  # å¤±è´¥ç‡è¶…10%å‘Šè­¦
            self.send_alert(deploy_results, success_count, failed_count)
            logger.warning(f"éƒ¨ç½²å¤±è´¥ç‡è¶…è¿‡10%ï¼Œå·²å‘é€å‘Šè­¦é€šçŸ¥")
            print("\nâš ï¸  éƒ¨ç½²å¤±è´¥ç‡è¶…è¿‡10%ï¼Œå·²å‘é€å‘Šè­¦é€šçŸ¥ï¼")

        return {
            "total": len(self.servers),
            "success": success_count,
            "failed": failed_count,
            "failed_hosts": [k for k, v in deploy_results.items() if v["status"] == "failed"],
            "report_path": report_path
        }
    
    def send_alert(self, deploy_results, success_count, failed_count):
        """å‘é€éƒ¨ç½²å‘Šè­¦ï¼ˆä»¥é’‰é’‰ä¸ºä¾‹ï¼‰"""
        try:
            import requests
            # é’‰é’‰æœºå™¨äººwebhookåœ°å€ï¼ˆæ›¿æ¢ä¸ºå®é™…åœ°å€ï¼‰
            webhook_url = os.getenv("DINGTALK_WEBHOOK")
            if not webhook_url:
                logger.warning("æœªé…ç½®é’‰é’‰webhookï¼Œè·³è¿‡å‘Šè­¦å‘é€")
                return
            
            failed_hosts = [k for k, v in deploy_results.items() if v["status"] == "failed"]
            alert_msg = {
                "msgtype": "markdown",
                "markdown": {
                    "title": f"Nginxæ‰¹é‡éƒ¨ç½²å‘Šè­¦ ({self.env}ç¯å¢ƒ)",
                    "text": f"""### Nginxæ‰¹é‡éƒ¨ç½²å‘Šè­¦
> ç¯å¢ƒ: {self.env}
> éƒ¨ç½²æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
> æ€»æœåŠ¡å™¨æ•°: {len(self.servers)}
> æˆåŠŸæ•°: {success_count}
> å¤±è´¥æ•°: {failed_count}
> å¤±è´¥ç‡: {failed_count/len(self.servers)*100:.1f}%

#### å¤±è´¥æœåŠ¡å™¨åˆ—è¡¨:
{chr(10).join([f"- {host}" for host in failed_hosts])}

#### å»ºè®®æ“ä½œ:
1. æ£€æŸ¥å¤±è´¥æœåŠ¡å™¨ç½‘ç»œè¿é€šæ€§
2. æ ¸å¯¹æœåŠ¡å™¨SSHè®¤è¯ä¿¡æ¯
3. æŸ¥çœ‹éƒ¨ç½²æŠ¥å‘Šè·å–è¯¦ç»†é”™è¯¯æ—¥å¿—
"""
                }
            }
            
            response = requests.post(webhook_url, json=alert_msg, timeout=10)
            if response.status_code == 200:
                logger.info("é’‰é’‰å‘Šè­¦å‘é€æˆåŠŸ")
            else:
                logger.error(f"é’‰é’‰å‘Šè­¦å‘é€å¤±è´¥: {response.text}")
        except Exception as e:
            logger.error(f"å‘é€å‘Šè­¦å¼‚å¸¸: {str(e)}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åˆå§‹åŒ–éƒ¨ç½²å™¨
    deployer = NginxDeployer(env="production", max_threads=20)
    
    # å¼€å§‹æ‰¹é‡éƒ¨ç½²
    results = deployer.deploy()
    
    # æ‰“å°æœ€ç»ˆç»Ÿè®¡
    print(f"\nğŸ‰ éƒ¨ç½²å®Œæˆï¼æˆåŠŸç‡: {results['success']/results['total']*100:.1f}%")
    if results['failed'] > 0:
        print(f"âš ï¸  éœ€è¦æ‰‹åŠ¨å¤„ç†çš„å¤±è´¥æœåŠ¡å™¨: {', '.join(results['failed_hosts'])}")</code></pre>
            </div>

            <h3>2. éƒ¨ç½²æµç¨‹å¯¹æ¯”è¡¨</h3>
            <table class="deploy-table">
                <thead>
                    <tr>
                        <th>éƒ¨ç½²æ–¹å¼</th>
                        <th>100å°æœåŠ¡å™¨è€—æ—¶</th>
                        <th>é”™è¯¯ç‡</th>
                        <th>äººå‘˜éœ€æ±‚</th>
                        <th>å¯é‡å¤æ€§</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>æ‰‹åŠ¨éƒ¨ç½²</td>
                        <td>10-15å°æ—¶</td>
                        <td>10-15%</td>
                        <td>2-3åè¿ç»´</td>
                        <td>ä½ï¼Œæ¯æ¬¡éœ€é‡æ–°æ“ä½œ</td>
                    </tr>
                    <tr>
                        <td>ä¼ ç»Ÿè„šæœ¬</td>
                        <td>2-3å°æ—¶</td>
                        <td>3-5%</td>
                        <td>1åè¿ç»´</td>
                        <td>ä¸­ç­‰ï¼Œéœ€å°‘é‡ä¿®æ”¹</td>
                    </tr>
                    <tr>
                        <td><strong>Pythonè‡ªåŠ¨åŒ–éƒ¨ç½²</strong></td>
                        <td><strong>30-45åˆ†é’Ÿ</strong></td>
                        <td><strong>0.5-1%</strong></td>
                        <td><strong>åŠä¸ªäººåŠ›</strong></td>
                        <td><strong>é«˜ï¼Œä¸€é”®é‡å¤éƒ¨ç½²</strong></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- æ€§èƒ½ä¼˜åŒ–ä¸å¤§è§„æ¨¡éƒ¨ç½²æŠ€å·§ -->
        <section class="content-section" id="optimize">
            <h2>å…«ã€æ€§èƒ½ä¼˜åŒ–ä¸å¤§è§„æ¨¡éƒ¨ç½²æŠ€å·§</h2>
            
            <h3>1. å¤§è§„æ¨¡éƒ¨ç½²æ¶æ„è®¾è®¡ï¼ˆ500+æœåŠ¡å™¨ï¼‰</h3>
            <div class="deploy-scene">
                <div class="scene-card">
                    <h4><i class="fas fa-network-wired"></i> åˆ†å¸ƒå¼éƒ¨ç½²</h4>
                    <p>æŒ‰æœºæˆ¿/åœ°åŸŸåˆ†ç»„éƒ¨ç½²ï¼Œä½¿ç”¨å¤šä¸ªéƒ¨ç½²èŠ‚ç‚¹å¹¶è¡Œæ‰§è¡Œï¼Œé¿å…å•ç‚¹ç“¶é¢ˆ</p>
                </div>
                <div class="scene-card">
                    <h4><i class="fas fa-database"></i> ä»»åŠ¡é˜Ÿåˆ—</h4>
                    <p>ä½¿ç”¨Redis/Celeryå®ç°ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ§åˆ¶å¹¶å‘æ•°ï¼Œæ”¯æŒå¤±è´¥ä»»åŠ¡é‡è¯•</p>
                </div>
                <div class="scene-card">
                    <h4><i class="fas fa-server"></i> åˆ†æ‰¹æ»šåŠ¨</h4>
                    <p>å°†æœåŠ¡å™¨åˆ†æˆå°æ‰¹æ¬¡ï¼ˆå¦‚æ¯æ‰¹20å°ï¼‰ï¼Œåˆ†æ‰¹éƒ¨ç½²ï¼Œé™ä½é£é™©</p>
                </div>
            </div>

            <h3>2. æ€§èƒ½ä¼˜åŒ–ä»£ç ç¤ºä¾‹</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code>#!/usr/bin/env python3
# optimize_deploy.py å¤§è§„æ¨¡éƒ¨ç½²æ€§èƒ½ä¼˜åŒ–
import asyncio
import aiohttp
import asyncssh
import yaml
from typing import List, Dict
import time
from concurrent.futures import ThreadPoolExecutor, ProcessPoolExecutor

# å¼‚æ­¥SSHæ‰§è¡Œï¼ˆ500+æœåŠ¡å™¨æ—¶æ€§èƒ½æå‡æ˜æ˜¾ï¼‰
class AsyncSSHDeployer:
    """å¼‚æ­¥SSHéƒ¨ç½²å™¨ï¼ˆæ”¯æŒ500+æœåŠ¡å™¨ï¼‰"""
    def __init__(self, max_concurrent=50):
        self.max_concurrent = max_concurrent
        self.semaphore = asyncio.Semaphore(max_concurrent)
    
    async def execute_command_async(self, host, port, username, password, command):
        """å¼‚æ­¥æ‰§è¡Œå‘½ä»¤"""
        async with self.semaphore:
            try:
                async with asyncssh.connect(
                    host=host,
                    port=port,
                    username=username,
                    password=password,
                    known_hosts=None
                ) as conn:
                    result = await conn.run(command, check=True)
                    return {"host": host, "status": "success", "output": result.stdout}
            except Exception as e:
                return {"host": host, "status": "failed", "error": str(e)}
    
    async def batch_execute_async(self, servers: List[Dict], commands: List[str]):
        """æ‰¹é‡å¼‚æ­¥æ‰§è¡Œå‘½ä»¤"""
        tasks = []
        for server in servers:
            for cmd in commands:
                task = self.execute_command_async(
                    host=server["host"],
                    port=server["port"],
                    username=server["username"],
                    password=server["password"],
                    command=cmd
                )
                tasks.append(task)
        
        # ä½¿ç”¨asyncio.gatherå¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
        results = await asyncio.gather(*tasks, return_exceptions=True)
        return results

# è¿æ¥æ± ä¼˜åŒ–ï¼ˆé¿å…é¢‘ç¹å»ºç«‹/æ–­å¼€è¿æ¥ï¼‰
class SSHConnectionPool:
    """SSHè¿æ¥æ± ï¼ˆå‡å°‘è¿æ¥å¼€é”€ï¼‰"""
    def __init__(self, max_size=20):
        self.max_size = max_size
        self.pool = {}
        self.lock = asyncio.Lock()
    
    async def get_connection(self, host, port, username, password):
        """ä»è¿æ¥æ± è·å–è¿æ¥"""
        key = f"{host}:{port}:{username}"
        
        async with self.lock:
            if key in self.pool:
                conn = self.pool[key]
                try:
                    # æµ‹è¯•è¿æ¥æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                    await conn.run("echo test", timeout=2)
                    return conn
                except:
                    # è¿æ¥å¤±æ•ˆï¼Œé‡æ–°å»ºç«‹
                    del self.pool[key]
            
            # åˆ›å»ºæ–°è¿æ¥
            conn = await asyncssh.connect(
                host=host, port=port,
                username=username, password=password,
                known_hosts=None
            )
            self.pool[key] = conn
            return conn
    
    async def close_all(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        for conn in self.pool.values():
            conn.close()
        self.pool.clear()

# æ™ºèƒ½æ‰¹å¤„ç†ï¼ˆæ ¹æ®æœåŠ¡å™¨æ€§èƒ½åŠ¨æ€è°ƒæ•´ï¼‰
class SmartBatchDeployer:
    """æ™ºèƒ½æ‰¹å¤„ç†éƒ¨ç½²å™¨"""
    def __init__(self, servers, test_batch_size=5):
        self.servers = servers
        self.test_batch_size = test_batch_size
        self.optimal_batch_size = 20  # é»˜è®¤å€¼
    
    def find_optimal_batch_size(self):
        """é€šè¿‡æµ‹è¯•æ‰¹æ¬¡æ‰¾åˆ°æœ€ä¼˜æ‰¹é‡å¤§å°"""
        print("ğŸ” æ­£åœ¨æµ‹è¯•æœ€ä¼˜æ‰¹é‡å¤§å°...")
        
        test_servers = self.servers[:self.test_batch_size]
        batch_sizes = [5, 10, 20, 30, 50]
        results = {}
        
        for batch_size in batch_sizes:
            start_time = time.time()
            # æ¨¡æ‹Ÿæ‰§è¡Œï¼ˆå®é™…ä¸­åº”æ‰§è¡Œè½»é‡çº§å‘½ä»¤ï¼‰
            for i in range(0, len(test_servers), batch_size):
                batch = test_servers[i:i+batch_size]
                # è¿™é‡Œåº”è¯¥æ˜¯å®é™…çš„éƒ¨ç½²é€»è¾‘
                time.sleep(0.1 * len(batch))  # æ¨¡æ‹Ÿè€—æ—¶
            
            total_time = time.time() - start_time
            results[batch_size] = total_time
            print(f"  æ‰¹é‡å¤§å° {batch_size}: {total_time:.2f}ç§’")
        
        # é€‰æ‹©æœ€ä¼˜æ‰¹é‡å¤§å°ï¼ˆå¹³è¡¡å¹¶å‘å’Œèµ„æºå ç”¨ï¼‰
        optimal = min(results, key=results.get)
        print(f"âœ… æ¨èæ‰¹é‡å¤§å°: {optimal}")
        self.optimal_batch_size = optimal
        return optimal
    
    def deploy_in_batches(self):
        """æŒ‰æœ€ä¼˜æ‰¹é‡å¤§å°åˆ†æ‰¹éƒ¨ç½²"""
        optimal_size = self.find_optimal_batch_size()
        
        total_batches = (len(self.servers) + optimal_size - 1) // optimal_size
        print(f"ğŸ“Š æ€»æœåŠ¡å™¨: {len(self.servers)} | æ‰¹é‡å¤§å°: {optimal_size} | æ€»æ‰¹æ¬¡æ•°: {total_batches}")
        
        for i in range(0, len(self.servers), optimal_size):
            batch = self.servers[i:i+optimal_size]
            batch_num = i // optimal_size + 1
            print(f"\nğŸš€ å¼€å§‹éƒ¨ç½²ç¬¬ {batch_num}/{total_batches} æ‰¹ ({len(batch)} å°æœåŠ¡å™¨)")
            
            # å®é™…éƒ¨ç½²é€»è¾‘
            # self._deploy_batch(batch)
            
            # æ¨¡æ‹Ÿéƒ¨ç½²æˆåŠŸ
            time.sleep(2)  # æ¨¡æ‹Ÿéƒ¨ç½²è€—æ—¶
            print(f"âœ… ç¬¬ {batch_num} æ‰¹éƒ¨ç½²å®Œæˆ")
            
            # æ‰¹æ¬¡é—´é—´éš”ï¼ˆé¿å…èµ„æºå³°å€¼ï¼‰
            if i + optimal_size < len(self.servers):
                print("â³ ç­‰å¾…3ç§’åç»§ç»­ä¸‹ä¸€æ‰¹...")
                time.sleep(3)

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åŠ è½½æœåŠ¡å™¨é…ç½®
    with open("servers.yaml", "r", encoding="utf-8") as f:
        config = yaml.safe_load(f)
    
    servers = config["servers"]["production"][:100]  # å–å‰100å°æµ‹è¯•
    
    # æ™ºèƒ½æ‰¹å¤„ç†éƒ¨ç½²
    smart_deployer = SmartBatchDeployer(servers)
    smart_deployer.deploy_in_batches()
    
    # å¼‚æ­¥éƒ¨ç½²ç¤ºä¾‹ï¼ˆéœ€å®‰è£…asyncssh: pip install asyncsshï¼‰
    # async_deployer = AsyncSSHDeployer(max_concurrent=50)
    # loop = asyncio.get_event_loop()
    # results = loop.run_until_complete(
    #     async_deployer.batch_execute_async(servers, ["hostname", "date"])
    # )</code></pre>
            </div>

            <div class="warning-tip">
                <strong>ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®:</strong>
                <p>1. è¿æ¥å¤ç”¨ï¼šä½¿ç”¨è¿æ¥æ± é¿å…é¢‘ç¹å»ºç«‹SSHè¿æ¥çš„å¼€é”€<br>
                2. å¼‚æ­¥IOï¼š500+æœåŠ¡å™¨æ—¶ä½¿ç”¨asyncio/asyncsshå¤§å¹…æå‡å¹¶å‘æ€§èƒ½<br>
                3. æ™ºèƒ½åˆ†æ‰¹ï¼šæ ¹æ®ç½‘ç»œè´¨é‡å’ŒæœåŠ¡å™¨æ€§èƒ½åŠ¨æ€è°ƒæ•´æ‰¹é‡å¤§å°<br>
                4. å†…å­˜ä¼˜åŒ–ï¼šå¤„ç†å¤§é‡æœåŠ¡å™¨æ—¶ä½¿ç”¨ç”Ÿæˆå™¨é¿å…å†…å­˜æº¢å‡º<br>
                5. ç»“æœç¼“å­˜ï¼šç¼“å­˜å·²æˆåŠŸéƒ¨ç½²çš„æœåŠ¡å™¨çŠ¶æ€ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ </p>
            </div>
        </section>

        <!-- æ€»ç»“ä¸æ‰©å±•åœºæ™¯ -->
        <section class="content-section" id="summary">
            <h2>ä¹ã€æ€»ç»“ä¸æ‰©å±•åœºæ™¯</h2>
            
            <h3>1. è‡ªåŠ¨åŒ–éƒ¨ç½²çš„ä»·å€¼æ€»ç»“</h3>
            <ul>
                <li><strong>æ•ˆç‡æå‡90%</strong>ï¼š100å°æœåŠ¡å™¨éƒ¨ç½²ä»10å°æ—¶ç¼©çŸ­åˆ°1å°æ—¶</li>
                <li><strong>é”™è¯¯ç‡é™ä½95%</strong>ï¼šäººå·¥æ“ä½œé”™è¯¯ç‡10%â†’è‡ªåŠ¨åŒ–é”™è¯¯ç‡0.5%</li>
                <li><strong>å¯é‡å¤å¯å®¡è®¡</strong>ï¼šæ‰€æœ‰æ“ä½œæœ‰æ—¥å¿—è®°å½•ï¼Œæ”¯æŒå®¡è®¡å’Œå›æ»š</li>
                <li><strong>æ ‡å‡†åŒ–é…ç½®</strong>ï¼šæ¶ˆé™¤ç¯å¢ƒå·®å¼‚ï¼Œç¡®ä¿æ‰€æœ‰æœåŠ¡å™¨é…ç½®ä¸€è‡´</li>
                <li><strong>è§£æ”¾äººåŠ›</strong>ï¼šè¿ç»´äººå‘˜å¯ä¸“æ³¨äºæ¶æ„è®¾è®¡å’Œé—®é¢˜æ’æŸ¥</li>
            </ul>

            <h3>2. æ‰©å±•åº”ç”¨åœºæ™¯</h3>
            <div class="deploy-scene">
                <div class="scene-card">
                    <h4><i class="fas fa-cloud"></i> äº‘æœåŠ¡å™¨è‡ªåŠ¨åŒ–</h4>
                    <p>ç»“åˆäº‘APIï¼ˆAWS/Aliyun/Tencent Cloudï¼‰å®ç°ï¼šåˆ›å»ºå®ä¾‹â†’åˆå§‹åŒ–â†’éƒ¨ç½²åº”ç”¨çš„å…¨æµç¨‹è‡ªåŠ¨åŒ–</p>
                </div>
                <div class="scene-card">
                    <h4><i class="fas fa-code-branch"></i> CI/CDé›†æˆ</h4>
                    <p>é›†æˆåˆ°Jenkins/GitLab CIï¼Œå®ç°ä»£ç æäº¤â†’è‡ªåŠ¨æµ‹è¯•â†’è‡ªåŠ¨éƒ¨ç½²çš„å®Œæ•´æµæ°´çº¿</p>
                </div>
                <div class="scene-card">
                    <h4><i class="fas fa-shield-alt"></i> å®‰å…¨åˆè§„æ£€æŸ¥</h4>
                    <p>æ‰¹é‡æ£€æŸ¥æœåŠ¡å™¨å®‰å…¨é…ç½®ï¼ˆé˜²ç«å¢™ã€å¯†ç ç­–ç•¥ã€æ¼æ´è¡¥ä¸ï¼‰å¹¶è‡ªåŠ¨ä¿®å¤</p>
                </div>
            </div>

            <h3>3. åç»­å­¦ä¹ å»ºè®®</h3>
            <div class="warning-tip">
                <strong>ğŸ“š æ·±å…¥å­¦ä¹ æ–¹å‘:</strong>
                <p>1. <strong>Ansible</strong>ï¼šä¸“ä¸šçš„è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼Œæ¯”çº¯Pythonè„šæœ¬æ›´è§„èŒƒ<br>
                2. <strong>Docker/K8s</strong>ï¼šå®¹å™¨åŒ–éƒ¨ç½²ï¼Œå®ç°æ›´è½»é‡çº§çš„åº”ç”¨éš”ç¦»<br>
                3. <strong>Terraform</strong>ï¼šåŸºç¡€è®¾æ–½å³ä»£ç ï¼Œç®¡ç†äº‘æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸ<br>
                4. <strong>ç›‘æ§å‘Šè­¦ä½“ç³»</strong>ï¼šPrometheus+Grafana+Alertmanagerå»ºç«‹å®Œæ•´ç›‘æ§é“¾<br>
                5. <strong>DevOpsæ–‡åŒ–</strong>ï¼šä¸ä»…ä»…æ˜¯å·¥å…·ï¼Œæ›´æ˜¯å›¢é˜Ÿåä½œå’Œå·¥ä½œæµç¨‹çš„å˜é©</p>
            </div>

            <h3>4. èµ„æºæ¨è</h3>
            <ul>
                <li><strong>GitHubé¡¹ç›®</strong>ï¼š<a href="https://github.com/ansible/ansible" target="_blank">Ansibleæºç </a> - å­¦ä¹ ä¸“ä¸šè‡ªåŠ¨åŒ–å·¥å…·è®¾è®¡</li>
                <li><strong>ä¹¦ç±æ¨è</strong>ï¼šã€ŠPythonè‡ªåŠ¨åŒ–è¿ç»´å®æˆ˜ã€‹ã€ŠAnsibleæƒå¨æŒ‡å—ã€‹</li>
                <li><strong>åœ¨çº¿è¯¾ç¨‹</strong>ï¼šUdemy "Automating Real-World Tasks with Python"</li>
                <li><strong>ç¤¾åŒº</strong>ï¼šStack Overflow #python #devopsï¼ŒReddit r/devops</li>
            </ul>

            <div class="danger-tip">
                <strong>âš ï¸ æœ€åçš„å®‰å…¨æé†’:</strong>
                <p>1. æ‰€æœ‰è„šæœ¬ä¸­<strong>ä¸è¦ç¡¬ç¼–ç å¯†ç </strong>ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡<br>
                2. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰<strong>åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯</strong><br>
                3. é‡è¦æ“ä½œ<strong>æ·»åŠ äººå·¥ç¡®è®¤ç¯èŠ‚</strong>ï¼Œé¿å…è¯¯æ“ä½œé€ æˆç”Ÿäº§äº‹æ•…<br>
                4. å®šæœŸ<strong>å¤‡ä»½å’Œæ¼”ç»ƒå›æ»š</strong>ï¼Œç¡®ä¿æ•…éšœæ—¶èƒ½å¿«é€Ÿæ¢å¤</p>
            </div>

            <h3>5. å®Œæ•´é¡¹ç›®ç»“æ„</h3>
            <div class="code-container">
                <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶ä»£ç </button>
                <pre><code># å®Œæ•´è‡ªåŠ¨åŒ–éƒ¨ç½²é¡¹ç›®ç»“æ„
auto-deploy-project/
â”œâ”€â”€ README.md                    # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ requirements.txt             # Pythonä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹ï¼ˆä¸å«çœŸå®å¯†ç ï¼‰
â”œâ”€â”€ .gitignore                   # Gitå¿½ç•¥æ–‡ä»¶é…ç½®
â”‚
â”œâ”€â”€ configs/                     # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ base.yaml               # åŸºç¡€é€šç”¨é…ç½®
â”‚   â”œâ”€â”€ production.yaml         # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ test.yaml               # æµ‹è¯•ç¯å¢ƒé…ç½®
â”‚   â””â”€â”€ development.yaml        # å¼€å‘ç¯å¢ƒé…ç½®
â”‚
â”œâ”€â”€ scripts/                     # æ ¸å¿ƒè„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ deploy_nginx.py         # Nginxéƒ¨ç½²ä¸»è„šæœ¬
â”‚   â”œâ”€â”€ batch_execute.py        # æ‰¹é‡å‘½ä»¤æ‰§è¡Œ
â”‚   â”œâ”€â”€ file_uploader.py        # æ–‡ä»¶æ‰¹é‡ä¸Šä¼ 
â”‚   â”œâ”€â”€ config_loader.py        # é…ç½®åŠ è½½å™¨
â”‚   â”œâ”€â”€ alert_manager.py        # å‘Šè­¦ç®¡ç†å™¨
â”‚   â””â”€â”€ monitor_server.py       # éƒ¨ç½²ç›‘æ§æœåŠ¡
â”‚
â”œâ”€â”€ templates/                   # é…ç½®æ–‡ä»¶æ¨¡æ¿
â”‚   â”œâ”€â”€ nginx_template.conf     # Nginxé…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ service_template.service # ç³»ç»ŸæœåŠ¡æ¨¡æ¿
â”‚   â””â”€â”€ app_config.json.j2      # åº”ç”¨é…ç½®æ¨¡æ¿
â”‚
â”œâ”€â”€ deploy_logs/                # éƒ¨ç½²æ—¥å¿—ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â””â”€â”€ deploy_20231215.log     # æŒ‰æ—¥æœŸè‡ªåŠ¨åˆ†å‰²æ—¥å¿—
â”‚
â”œâ”€â”€ deploy_reports/             # éƒ¨ç½²æŠ¥å‘Šç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â””â”€â”€ nginx_deploy_20231215_143022.txt
â”‚
â”œâ”€â”€ temp/                       # ä¸´æ—¶æ–‡ä»¶ç›®å½•ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
â”‚
â”œâ”€â”€ fabfile.py                  # Fabric3éƒ¨ç½²è„šæœ¬
â”‚
â””â”€â”€ servers.yaml                # æœåŠ¡å™¨æ¸…å•é…ç½®æ–‡ä»¶</code></pre>
            </div>

            <div class="warning-tip" style="margin-top: 30px;">
                <strong>ğŸ¯ è¡ŒåŠ¨å»ºè®®:</strong>
                <p>1. <strong>ç«‹å³å®è·µ</strong>ï¼šä»5å°æµ‹è¯•æœåŠ¡å™¨å¼€å§‹ï¼Œé€æ­¥æ‰©å±•åˆ°ç”Ÿäº§ç¯å¢ƒ<br>
                2. <strong>æ–‡æ¡£åŒ–</strong>ï¼šä¸ºæ¯ä¸ªè„šæœ¬ç¼–å†™æ¸…æ™°çš„READMEå’Œä½¿ç”¨è¯´æ˜<br>
                3. <strong>å›¢é˜Ÿåˆ†äº«</strong>ï¼šå°†æˆåŠŸç»éªŒåˆ†äº«ç»™å›¢é˜Ÿï¼Œæ¨åŠ¨DevOpsæ–‡åŒ–å»ºè®¾<br>
                4. <strong>æŒç»­æ”¹è¿›</strong>ï¼šæ ¹æ®å®é™…ä½¿ç”¨åé¦ˆä¸æ–­ä¼˜åŒ–è„šæœ¬å’Œæµç¨‹</p>
            </div>
        </section>

        <!-- æ–‡ç« ç»“æŸè¯­ -->
        <div style="text-align: center; margin: 50px 0 30px; padding: 30px; border-radius: 12px; background: linear-gradient(135deg, rgba(249,115,22,0.1), rgba(59,130,246,0.1));">
            <h3 style="color: #f97316; margin-bottom: 15px;">ğŸš€ å¼€å§‹ä½ çš„è‡ªåŠ¨åŒ–ä¹‹æ—…å§ï¼</h3>
            <p style="margin-bottom: 20px;">æŒæ¡Pythonè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œä½ ä¸ä»…èƒ½å¤§å¹…æå‡å·¥ä½œæ•ˆç‡ï¼Œæ›´èƒ½å°†å®è´µçš„æ—¶é—´æŠ•å…¥åˆ°æ›´æœ‰ä»·å€¼çš„æŠ€æœ¯ç ”ç©¶å’Œæ¶æ„è®¾è®¡ä¸­ã€‚</p>
            <p style="font-size: 14px; color: #6b7280;">å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€äº¤æµï¼</p>
        </div>

        <!-- æ–‡ç« ä¿¡æ¯ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
            <div>
                <span style="font-size: 14px; color: #6b7280;">æ ‡ç­¾ï¼š</span>
                <span style="background: #f3f4f6; color: #4b5563; padding: 4px 12px; border-radius: 20px; font-size: 13px; margin-right: 8px;">Pythonè‡ªåŠ¨åŒ–</span>
                <span style="background: #f3f4f6; color: #4b5563; padding: 4px 12px; border-radius: 20px; font-size: 13px; margin-right: 8px;">è¿ç»´éƒ¨ç½²</span>
                <span style="background: #f3f4f6; color: #4b5563; padding: 4px 12px; border-radius: 20px; font-size: 13px; margin-right: 8px;">æœåŠ¡å™¨ç®¡ç†</span>
                <span style="background: #f3f4f6; color: #4b5563; padding: 4px 12px; border-radius: 20px; font-size: 13px;">DevOps</span>
            </div>
            <div style="font-size: 14px; color: #6b7280;">
                <span>æœ€åæ›´æ–°ï¼š2025-12-15</span>
            </div>
        </div>
    </main>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <div class="back-to-top" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </div>

    <script>
        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('light')) {
                body.classList.remove('light');
                body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark');
                body.classList.add('light');
                localStorage.setItem('theme', 'light');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.remove('light', 'dark');
            document.body.classList.add(savedTheme);
            
            // åˆå§‹åŒ–ä»£ç å¤åˆ¶åŠŸèƒ½
            initCopyButtons();
        });

        // å¤åˆ¶ä»£ç åŠŸèƒ½
        function copyCode(button) {
            const codeBlock = button.nextElementSibling;
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                button.classList.add('copied');
                button.textContent = 'å·²å¤åˆ¶ï¼';
                
                setTimeout(() => {
                    button.classList.remove('copied');
                    button.textContent = 'å¤åˆ¶ä»£ç ';
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                button.textContent = 'å¤åˆ¶å¤±è´¥';
                setTimeout(() => {
                    button.textContent = 'å¤åˆ¶ä»£ç ';
                }, 2000);
            });
        }

        // åˆå§‹åŒ–æ‰€æœ‰å¤åˆ¶æŒ‰é’®
        function initCopyButtons() {
            const copyButtons = document.querySelectorAll('.copy-btn');
            copyButtons.forEach(button => {
                button.addEventListener('click', () => copyCode(button));
            });
        }

        // å›åˆ°é¡¶éƒ¨åŠŸèƒ½
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // æ˜¾ç¤º/éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
        window.addEventListener('scroll', () => {
            const backToTopBtn = document.querySelector('.back-to-top');
            if (window.scrollY > 300) {
                backToTopBtn.classList.add('visible');
            } else {
                backToTopBtn.classList.remove('visible');
            }
        });

        // ç›®å½•ç‚¹å‡»å¹³æ»‘æ»šåŠ¨
        document.querySelectorAll('.toc a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                
                if (targetElement) {
                    const offset = 100; // å¯¼èˆªæ é«˜åº¦åç§»
                    const targetPosition = targetElement.offsetTop - offset;
                    
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                    
                    // æ›´æ–°URLå“ˆå¸Œï¼ˆå¯é€‰ï¼‰
                    history.pushState(null, null, `#${targetId}`);
                }
            });
        });

        // ç›‘å¬æ»šåŠ¨ï¼Œé«˜äº®å½“å‰æŸ¥çœ‹çš„ç« èŠ‚
        window.addEventListener('scroll', () => {
            const sections = document.querySelectorAll('.content-section');
            const navLinks = document.querySelectorAll('.toc a');
            
            let currentSection = '';
            
            sections.forEach(section => {
                const sectionTop = section.offsetTop - 150;
                const sectionHeight = section.clientHeight;
                
                if (window.scrollY >= sectionTop && window.scrollY < sectionTop + sectionHeight) {
                    currentSection = section.getAttribute('id');
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${currentSection}`) {
                    link.classList.add('active');
                }
            });
        });

        // ä»£ç å—è¯­æ³•é«˜äº®ï¼ˆç®€å•å®ç°ï¼‰
        function highlightCode() {
            const codeBlocks = document.querySelectorAll('pre code');
            codeBlocks.forEach(block => {
                // ç®€å•çš„å…³é”®å­—é«˜äº®
                const code = block.textContent;
                const highlighted = code
                    .replace(/\b(def|class|import|from|as|try|except|if|else|elif|for|while|return|break|continue)\b/g, '<span class="keyword">$1</span>')
                    .replace(/\b(True|False|None)\b/g, '<span class="constant">$1</span>')
                    .replace(/("[^"]*"|'[^']*')/g, '<span class="string">$1</span>')
                    .replace(/#.*$/gm, '<span class="comment">$&</span>');
                
                block.innerHTML = highlighted;
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œä»£ç é«˜äº®
        window.addEventListener('load', highlightCode);
    </script>
</body>
</html>
